{% extends "header.html" %}
{% block title %}Provider Class Detail{% endblock %}
{% block content %}

<h3>Class Students and Competencies</h3>

<style>
  .scroll-table-wrapper {
    overflow-x: auto;
    overflow-y: auto;
    max-width: 100%;
    max-height: 80vh;
    position: relative;
  }

  #studentsTable {
    border-collapse: collapse;
    width: max-content;
    table-layout: fixed;
  }

  #studentsTable th,
  #studentsTable td {
    padding: 8px;
    text-align: center;
    vertical-align: bottom;
    border: 1px solid #ddd;
    white-space: normal;
    word-wrap: break-word;
    background-color: white;
  }

  thead th {
    position: sticky;
    top: 0;
    z-index: 10;
    background-color: white;
    font-weight: bold;
  }

  #studentsTable th.col-0,
  #studentsTable td.col-0 {
    position: sticky;
    left: 0;
    width: 200px;
    z-index: 5;
    background-color: #f8f9fa;
  }

  #studentsTable th.col-1,
  #studentsTable td.col-1 {
    position: sticky;
    left: 200px;
    width: 200px;
    z-index: 5;
    background-color: #f8f9fa;
  }

  #studentsTable th.col-2,
  #studentsTable td.col-2 {
    position: sticky;
    left: 400px;
    width: 120px;
    z-index: 5;
    background-color: #f8f9fa;
  }

  #studentsTable th.col-0,
  #studentsTable th.col-1,
  #studentsTable th.col-2 {
    z-index: 11;
  }

  #studentsTable th:not(.col-0):not(.col-1):not(.col-2),
  #studentsTable td:not(.col-0):not(.col-1):not(.col-2) {
    width: 175px;
  }

  input[type="checkbox"] {
    transform: scale(1.2);
  }

  select {
    width: 100%;
  }
</style>

<div class="scroll-table-wrapper">
  <table id="studentsTable" class="table table-bordered table-sm">
    <thead>
      <tr>
        <th class="col-0">Last Name</th>
        <th class="col-1">Preferred Name</th>
        <th class="col-2">Year Level</th>
        {% for col in columns[3:] %}
          <th>{{ col|safe }}</th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for student in students %}
      <tr>
        <td class="col-0">{{ student.LastName }}</td>
        <td class="col-1">{{ student.PreferredName }}</td>
        <td class="col-2">{{ student.YearLevelID }}</td>
        {% for col in columns[3:] %}
        <td>
          {% set val = student[col]|default('')|string|trim %}
          {% if col in ["Scenario One - Selected <br> (7-8)", "Scenario Two - Selected <br> (7-8)"] %}
            <select class="form-control">
              {% for i in range(5) %}
                <option value="{{ i }}" {% if val == i|string %}selected{% endif %}>{{ i }}</option>
              {% endfor %}
            </select>
          {% else %}
            <input type="checkbox"
              name="competency"
              data-nsn="{{ student.NSN }}"
              data-competency="{{ col }}"
              data-competencyid="{{ competency_id_map[col]['CompetencyID'] }}"
              data-yeargroupid="{{ competency_id_map[col]['YearGroupID'] }}"
              {% if val == "Y" %}checked{% endif %}
            />
          {% endif %}
        </td>
        {% endfor %}
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
  document.querySelectorAll('input[type="checkbox"][name="competency"]').forEach(cb => {
    cb.addEventListener("change", function () {
      const nsn = this.dataset.nsn;
      const headerName = this.dataset.competency;  // Use the header name here (e.g., "Competency 1")
      const status = this.checked ? 1 : 0;

      // Debugging: Print the data being sent
      console.log("Sending data:", {
        nsn: nsn,
        headerName: headerName,
        status: status
      });

      fetch('/update_competency', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          nsn: nsn,
          header_name: headerName,  // Send header name instead of competency
          status: status
        })
      })
      .then(response => response.json())
      .then(data => {
        if (!data.success) {
          alert("âŒ Failed to update competency.");
        }
      })
      .catch(err => {
        console.error("Update error:", err);
      });
    });
  });
});


</script>

{% endblock %}
