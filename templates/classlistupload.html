{% extends "header.html" %}

{% block title %}Upload Class List{% endblock %}

{% block content %}
<div class="container mt-5">
  <h2 class="mb-4">Upload Class List</h2>
  
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mt-3">
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <form id="upload-form" action="/classlistupload" method="post" enctype="multipart/form-data" class="row g-3">
    <div class="col-md-6">
      <label for="provider" class="form-label">Provider</label>
      <select id="provider" name="provider" class="form-select" required>
        <option value="">Select a provider</option>
        {% for provider in providers %}
          <option value="{{ provider.ProviderID }}" {% if selected_provider == provider.ProviderID %}selected{% endif %}>{{ provider.Description }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-6">
      <label for="school" class="form-label">School</label>
      <select class="form-select" id="school" name="school" required>
        <option selected disabled value="">Select a school</option>
        {% for name in schools %}
          <option value="{{ name }}" {% if selected_school == name %}selected{% endif %}>{{ name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-3">
      <label for="term" class="form-label">Term</label>
      <select class="form-select" id="term" name="term" required>
        <option value="1" {% if selected_term == '1' %}selected{% endif %}>Term 1</option>
        <option value="2" {% if selected_term == '2' %}selected{% endif %}>Term 2</option>
        <option value="3" {% if selected_term == '3' %}selected{% endif %}>Term 3</option>
        <option value="4" {% if selected_term == '4' %}selected{% endif %}>Term 4</option>
      </select>
    </div>

    <div class="col-md-3">
      <label for="year" class="form-label">Year</label>
      <select class="form-select" id="year" name="year" required>
        {% for y in range(2023, 2026) %}
          <option value="{{ y }}" {% if selected_year == y %}selected{% endif %}>{{ y }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-6">
      <label for="csv_file" class="form-label">Upload CSV File</label>
      <input class="form-control" type="file" id="csv_file" name="csv_file" accept=".csv">
    </div>

    <input type="hidden" id="column_mappings" name="column_mappings">

    <div class="col-12 d-flex justify-content-between">
      <button type="submit" name="action" value="preview" class="btn btn-secondary">Preview File</button>
      {% if preview_data and not preview_data[0].get('ErrorMessage') %}
        <button type="submit" name="action" value="validate" class="btn btn-success">Validate Data</button>
      {% endif %}
    </div>
  </form>

  {% if preview_data %}
  <div class="mt-5">
    <h4>Preview</h4>
    <div class="table-responsive">
      <table class="table table-bordered table-striped">
        <thead>
          <tr>
            {% for col in preview_data[0].keys() %}
              <th>
                {{ col }}
                {% if col not in ['ErrorFields', 'ErrorMessage'] %}
                  <div>
                    <select name="map_{{ col }}" class="form-select form-select-sm mt-1" data-remember="{{ col }}">
                      <option value="">Clean Column Name</option>
                      <option value="NSN">NSN</option>
                      <option value="FirstName">First Name</option>
                      <option value="LastName">Last Name</option>
                      <option value="PreferredName">Preferred Name</option>
                      <option value="BirthDate">Birth Date</option>
                      <option value="Ethnicity">Ethnicity</option>
                      <option value="YearLevel">Year Level</option>
                    </select>
                  </div>
                {% endif %}
              </th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for row in preview_data %}
            {% set error_columns = row.ErrorFields.split(',') if row.ErrorFields else [] %}
            <tr>
              {% for key, val in row.items() %}
                {% if key == 'ErrorFields' %}
                  <td class="{% if not row.Match and row.ErrorFields %}text-danger fw-bold{% elif row.Match and row.ErrorFields %}text-warning fw-bold{% elif not row.ErrorFields %}text-dark{% endif %}">
                    {{ 'None' if row.ErrorFields == None or row.ErrorFields == '' else row.ErrorFields }}
                  </td>
                {% elif key == 'ErrorMessage' %}
                  <td class="{% if val %}text-danger fw-bold{% endif %}">
                    {{ val if val else 'No error message' }}
                  </td>
                {% elif key == 'YearLevel' %}
                  <td class="{% if row.YearLevel is none %}bg-danger text-dark{% endif %}">
                    {{ row.YearLevel if row.YearLevel is not none else '' }}
                  </td>
                {% else %}
                  <td class="{% if key in error_columns and row.Match %}bg-warning text-dark {% elif key in error_columns and not row.Match %}bg-danger text-white {% endif %}">
                    {{ '' if val is none or val|string == 'nan' else val }}
                  </td>
                {% endif %}
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
<button type="button" id="exportCsvButton" class="btn btn-primary">Export to CSV</button>
  </div>
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
  document.getElementById("provider").addEventListener("change", function () {
    const providerID = this.value;
    fetch(`/get_schools_for_provider?provider_id=${providerID}`)
      .then((response) => response.json())
      .then((data) => {
        const schoolDropdown = document.getElementById("school");
        schoolDropdown.innerHTML = '<option value="">Select a school</option>';
        data.forEach((school) => {
          const option = document.createElement("option");
          option.value = school;
          option.textContent = school;
          schoolDropdown.appendChild(option);
        });
      });
  });

  function updateMappingOptions() {
    const selects = document.querySelectorAll('select[name^="map_"]');
    const selectedValues = Array.from(selects)
      .map((s) => s.value)
      .filter((v) => v !== "");

    selects.forEach((select) => {
      const currentValue = select.value;
      Array.from(select.options).forEach((option) => {
        if (option.value === "") return;
        option.disabled =
          selectedValues.includes(option.value) &&
          option.value !== currentValue;
      });
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
    const selects = document.querySelectorAll('select[name^="map_"]');
    const stored = localStorage.getItem("column_mappings");
    if (stored) {
      const mapping = JSON.parse(stored);
      selects.forEach((select) => {
        const key = select.getAttribute("data-remember");
        if (mapping[key]) select.value = mapping[key];
      });
    }

    selects.forEach((select) => {
      select.addEventListener("change", updateMappingOptions);
    });
    updateMappingOptions();

    document
      .getElementById("upload-form")
      .addEventListener("submit", function () {
        const mapping = {};
        document.querySelectorAll('select[name^="map_"]').forEach((select) => {
          const col = select.name.replace("map_", "");
          if (select.value) mapping[col] = select.value;
        });
        localStorage.setItem("column_mappings", JSON.stringify(mapping));
        document.getElementById("column_mappings").value =
          JSON.stringify(mapping);
      });
  });

  document.getElementById("exportCsvButton").addEventListener("click", function() {
    fetch('/export_csv', {
        method: 'POST',  // Use POST to send data (if needed)
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ /* optional data to send, like filters */ })
    })
    .then(response => response.blob())
    .then(blob => {
        // Create a temporary link element
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'preview_data.csv';
        link.click();  // Trigger the download
    })
    .catch(error => console.error('Error exporting CSV:', error));
});
</script>
{% endblock %}
