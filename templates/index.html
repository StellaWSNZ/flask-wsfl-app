{% extends "header.html" %}

{% block title %}Student Tools{% endblock %}

{% block content %}

<div class="row g-4">
  <!-- Upload CSV -->
  <div class="col-md-6">
    <div class="card h-100">
      <div class="card-header">ðŸ“¤ Upload CSV</div>
      <div class="card-body">
        <form action="/upload" method="post" enctype="multipart/form-data" class="row g-3 align-items-end" onsubmit="return checkFileSelected()">
          <div class="col-12">
            <label for="csv_file_input" class="form-label">CSV File</label>
            <input type="file" name="csv_file" class="form-control" accept=".csv" id="csv_file_input" required>
          </div>
          <div class="col-6">
            <label for="year_input" class="form-label">Year</label>
            <select name="year" class="form-select" id="year_input" required>
              {% for y in range(2023, 2026) %}
              <option value="{{ y }}" {% if y == 2025 %}selected{% endif %}>{{ y }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-6">
            <label for="term_input" class="form-label">Term</label>
            <select name="term" class="form-select" id="term_input" required>
              <option value="1" selected>Term 1</option>
              <option value="2">Term 2</option>
              <option value="3">Term 3</option>
              <option value="4">Term 4</option>
            </select>
          </div>
          <div class="col-12">
            <label for="provider" class="form-label">Provider</label>
            <select id="provider" class="form-select" name="provider" onchange="loadSchools()" required>
              <option disabled selected value></option>
              {% for name in providers %}
              <option value="{{ name }}">{{ name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-12">
            <label for="school" class="form-label">School</label>
            <select id="school" class="form-select" name="school" required>
              <option value="">Select a school</option>
            </select>
          </div>
          <div class="col-6">
            <label for="teacher_name" class="form-label">Teacher Name</label>
            <input type="text" class="form-control" id="teacher_name" name="teacher_name">
          </div>
          <div class="col-6">
            <label for="class_name" class="form-label">Class Name</label>
            <input type="text" class="form-control" id="class_name" name="class_name">
          </div>
          <div class="col-12">
            <button type="submit" class="btn btn-success w-100">Upload</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Generate Report -->
  <div class="col-md-6">
    <div class="card h-100">
      <div class="card-header">ðŸ“ˆ Generate Report</div>
      <div class="card-body">
        <form action="/generate_report" method="post" class="row g-3 align-items-end">
          <div class="col-12">
            <label for="report_type" class="form-label">Report Type</label>
            <select name="report_type" class="form-select" id="report_type" required>
              <option value="Provider">Provider Performance</option>
              <option value="National">National Performance</option>
              <option value="Competency">Competency Performance</option>
            </select>
          </div>

          <div class="col-6">
            <label for="report_year" class="form-label">Year</label>
            <select name="year" class="form-select" id="report_year" required>
              {% for y in range(2023, 2026) %}
              <option value="{{ y }}" {% if y == 2025 %}selected{% endif %}>{{ y }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-6">
            <label for="report_term" class="form-label">Term</label>
            <select name="term" class="form-select" id="report_term" required>
              <option value="1" selected>Term 1</option>
              <option value="2">Term 2</option>
              <option value="3">Term 3</option>
              <option value="4">Term 4</option>
            </select>
          </div>

          <!-- Provider dropdown (only for Provider Performance) -->
          <div class="col-12" id="provider-options">
            <label for="report_provider" class="form-label">Provider</label>
            <select name="provider" class="form-select" id="report_provider">
              {% for name in providers %}
              <option value="{{ name }}">{{ name }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Competency dropdown (only for Competency Performance) -->
          <div class="col-12" id="competency-options" style="display: none;">
            <label for="competency" class="form-label">Competency</label>
            <select name="competency" class="form-select" id="competency">
              {% for comp in competencies %}
              <option value="{{ comp }}">{{ comp }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-12">
            <button type="submit" class="btn btn-primary w-100">View Report</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
  function loadSchools() {
    const provider = document.getElementById("provider").value;
    const schoolDropdown = document.getElementById("school");
    schoolDropdown.innerHTML = "";
    if (!provider) return;
    fetch(`/get_schools?provider=${encodeURIComponent(provider)}`)
      .then(response => response.json())
      .then(data => {
        if (data.length > 0) {
          data.forEach(school => {
            const option = document.createElement("option");
            option.value = school;
            option.text = school;
            schoolDropdown.appendChild(option);
          });
        } else {
          const option = document.createElement("option");
          option.text = "No schools found";
          schoolDropdown.appendChild(option);
        }
      });
  }

  function checkFileSelected() {
    const fileInput = document.getElementById("csv_file_input");
    if (!fileInput.value) {
      alert("Please select a CSV file to upload.");
      return false;
    }

    document.getElementById("uploadProgress").style.display = "block";
    const interval = setInterval(() => {
      fetch("/progress")
        .then(response => response.json())
        .then(data => {
          const percent = Math.floor((data.current / data.total) * 100);
          const bar = document.getElementById("progressBar");
          bar.style.width = percent + "%";
          bar.innerText = percent + "%";
          bar.setAttribute("aria-valuenow", percent);
          if (data.done) clearInterval(interval);
        });
    }, 500);
    return true;
  }

  document.addEventListener("DOMContentLoaded", function () {
    const reportType = document.getElementById("report_type");
    const providerOptions = document.getElementById("provider-options");
    const competencyOptions = document.getElementById("competency-options");

    function updateVisibility() {
      const type = reportType.value;
      providerOptions.style.display = type === "Provider" ? "block" : "none";
      competencyOptions.style.display = type === "Competency" ? "block" : "none";
    }

    reportType.addEventListener("change", updateVisibility);
    updateVisibility();
  });
</script>
{% endblock %}
