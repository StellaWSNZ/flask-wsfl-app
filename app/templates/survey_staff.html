{% extends "header.html" %}
{% block title %}Staff Form Responses{% endblock %}

{% block content %}
<div class="container mt-5">
  <h2 class="mb-4 text-primary text-center">Staff Form Responses</h2>

  <!-- 🔍 Filter Form (entity pickers) -->
  <form method="GET" id="filterForm" class="mb-4">
    <div class="row g-3 justify-content-center align-items-end">
      <div class="col-md-3">
        <label for="entity_type" class="form-label">Entity Type</label>
        <select class="form-select" id="entity_type" name="entity_type" required>
          {% for et in allowed_entity_types %}
            <option value="{{ et.value }}" {% if entity_type == et.value %}selected{% endif %}>
              {{ et.label }}
            </option>
          {% endfor %}
        </select>

      </div>
      <div class="col-md-4">
        <label for="entity_id" class="form-label" id="entityLabel">Select {{ entity_type }}</label>
        <select class="form-select" id="entity_id" name="entity_id" required>
          <option value="">-- Choose an entity --</option>
        </select>
      </div>
      <div class="col-md-2">
        <button type="submit" class="btn btn-primary w-100">View</button>
      </div>
    </div>
  </form>

  <!-- 🔎 Client-side filter/sort controls (only bottom three filters styled/centered) -->
  {% if staff_surveys %}
  <div class="filter-bar row g-2 mb-3 justify-content-center text-center">
    <div class="col-12 col-md-3">
      <input id="filterName" type="text" class="form-control" placeholder="Filter by form description or email">
    </div>
    <div class="col-12 col-md-3">
      <select id="filterForm" class="form-select">
        <option value="">All forms</option>
        {% for form_title in staff_surveys|map(attribute='Title')|unique|list %}
          <option value="{{ form_title }}">{{ form_title }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-12 col-md-3">
      <select id="sortBy" class="form-select">
        <option value="submitted_desc">Submitted (newest)</option>
        <option value="submitted_asc">Submitted (oldest)</option>
        
      </select>
    </div>
  </div>
  {% endif %}

  <!-- 📋 Table View -->
  {% if staff_surveys %}
  <div class="table-responsive mt-2">
    <table class="table table-bordered align-middle shadow-sm bg-white rounded table-hover">
      <thead class="table-dark-blue text-white sticky-top">
        <tr>
          <th>Form Type</th>
          <th>Form Description</th>
          <th>Email</th>
          <th>Submitted</th>
          <th class="text-center">Action</th>
        </tr>
      </thead>
      <tbody>
        {% for s in staff_surveys %}
        <tr class="click-row position-relative" data-ts="{{ s.SubmittedDate.timestamp() if s.SubmittedDate }}">
          <td>
            <span class="badge {{ s.BadgeClass }}">{{ s.Title }}</span>
            <a class="stretched-link visually-hidden-focusable"
               href="{{ url_for('survey_bp.view_my_survey_response', respondent_id=s.RespondentID) }}"
               aria-label="Open {{ s.Title }} for {{ s.Name or (s.FirstName ~ ' ' ~ s.Surname) }}">
              Open
            </a>
          </td>
          <td>{{ s.Details }}</td>
          <td>{{ s.SubjectEmail }}</td>
          <td>
            {% if s.SubmittedDate %}
              {{ s.SubmittedDate.strftime('%d %B %Y, %I:%M %p') }}
            {% else %}
              —
            {% endif %}
          </td>
          <td class="text-center">
            <a href="{{ url_for('survey_bp.view_my_survey_response', respondent_id=s.RespondentID) }}"
               class="btn btn-sm btn-outline-primary" target="_blank">
              View Response
            </a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% elif selected_entity_id %}
  <div class="alert alert-info text-center mt-4">
    No survey responses found for this selection.
  </div>
  {% endif %}
</div>

<!-- 💅 Custom CSS -->
<style>
.table-dark-blue th { background-color: #1a427d; color: white; }
.sticky-top { position: sticky; top: 0; z-index: 1; }
.click-row { cursor: pointer; }

/* Dark blue outline ONLY for bottom three filters */
.filter-bar .form-control,
.filter-bar .form-select {
  border-color: #1a427d;
}
.filter-bar .form-control:focus,
.filter-bar .form-select:focus {
  border-color: #1a427d;
  box-shadow: 0 0 0 0.2rem rgba(26, 66, 125, 0.25);
}

/* Deterministic blue shades for badges */
.badge.badge-blue-1 { background-color: #bfdbfe !important; color: #1e3a8a !important; } /* Very Light Blue */
.badge.badge-blue-2 { background-color: #60a5fa !important; color: #fff !important; }   /* Light Sky Blue */
.badge.badge-blue-3 { background-color: #3b82f6 !important; color: #fff !important; }   /* Bright Blue */
.badge.badge-blue-4 { background-color: #2563eb !important; color: #fff !important; }   /* Strong Mid Blue */
.badge.badge-blue-5 { background-color: #1e40af !important; color: #fff !important; }   /* Navy Blue */
.badge.badge-blue-6 { background-color: #312e81 !important; color: #fff !important; }   /* Deep Indigo */


.filter-bar .col-12 {
  display: flex;
  align-items: stretch;
}
.filter-bar .form-control,
.filter-bar .form-select {
  flex: 1;   /* make them expand equally */
}


</style>

<!-- JS: Load /get_entities dynamically & client-side filter/sort -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const entityTypeSelect = document.getElementById("entity_type");
  const entityIdSelect   = document.getElementById("entity_id");
  const entityLabel      = document.getElementById("entityLabel");
  const selectedEntityId = "{{ selected_entity_id }}";

  function loadEntities(type) {
    if (!type) return;
    entityLabel.textContent = `Select ${type}`;
    entityIdSelect.innerHTML = '<option value="">Loading...</option>';

    fetch(`/get_entities?entity_type=${encodeURIComponent(type)}`)
      .then(res => res.json())
      .then(data => {
        entityIdSelect.innerHTML = '<option value="">-- Choose --</option>';
        (data || []).forEach(entity => {
          const option = document.createElement("option");
          option.value = entity.id;
          option.textContent = entity.name || entity.label || entity.id;
          if (String(entity.id) === selectedEntityId) option.selected = true;
          entityIdSelect.appendChild(option);
        });
      })
      .catch(err => {
        console.error("Error loading entities:", err);
        entityIdSelect.innerHTML = '<option value="">-- Failed to load --</option>';
      });
  }

  loadEntities(entityTypeSelect.value);
  entityTypeSelect.addEventListener("change", function () {
    loadEntities(this.value);
  });

  // --- Filters / sorting (only if table rendered) ---
  const tbody = document.querySelector("table tbody");
  if (tbody) {
    const allRows = Array.from(tbody.querySelectorAll("tr"));
    const collate = new Intl.Collator();

    function getCell(tr, idx) { return tr.children[idx]?.textContent.trim() || ""; }

    function applyFilterSort() {
      const q     = (document.getElementById("filterName")?.value || "").toLowerCase();
      const form  = (document.getElementById("filterForm")?.value || "");
      const sort  = (document.getElementById("sortBy")?.value || "submitted_desc");

      let out = allRows.filter(tr => {
        const formTitle = getCell(tr, 0);       // includes badge text
        const name      = getCell(tr, 1);
        const email     = getCell(tr, 2);
        const matchesQ  = !q || (name.toLowerCase().includes(q) || email.toLowerCase().includes(q));
        const matchesF  = !form || formTitle === form;
        return matchesQ && matchesF;
      });

      out.sort((a, b) => {
        const titleA = getCell(a, 0), titleB = getCell(b, 0);
        const nameA  = getCell(a, 1), nameB = getCell(b, 1);
        const tsA    = Number(a.getAttribute("data-ts") || 0);
        const tsB    = Number(b.getAttribute("data-ts") || 0);

        switch (sort) {
          case "submitted_desc": return tsB - tsA;
          case "submitted_asc":  return tsA - tsB;
          case "name_asc":       return collate.compare(nameA, nameB);
          case "name_desc":      return collate.compare(nameB, nameA);
          case "form_asc":       return collate.compare(titleA, titleB);
          default:               return 0;
        }
      });

      tbody.replaceChildren(...out);
    }

    ["filterName","filterForm","sortBy"].forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        el.addEventListener("input", applyFilterSort);
        el.addEventListener("change", applyFilterSort);
      }
    });
    applyFilterSort();
  }
});
</script>
{% endblock %}
