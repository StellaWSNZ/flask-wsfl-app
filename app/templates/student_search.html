{% extends "header.html" %} {% block title %}Search Students{% endblock %} {%
block content %}

<div class="container mt-5">
  <h2 class="mb-4 text-centre text-primary">Search for a Student</h2>

  <!-- Page Notification area -->
  <div id="notification" class="alert d-none" role="alert"></div>

  <!-- Search + sort -->
  <div class="row mb-3">
    <div class="col-md-6">
      <input
        type="text"
        id="search-input"
        class="form-control"
        placeholder="Type a name..."
        autocomplete="off"
      />
    </div>
    <div class="col-md-4">
      <select id="sort-select" class="form-select">
        <option value="FirstName_asc">Sort by First Name (A-Z)</option>
        <option value="FirstName_desc">Sort by First Name (Z-A)</option>
        <option value="LastName_asc">Sort by Last Name (A-Z)</option>
        <option value="LastName_desc">Sort by Last Name (Z-A)</option>
      </select>
    </div>
  </div>

  <div id="results" class="row g-3"></div>
</div>

<!-- Edit Modal -->
<div
  class="modal fade"
  id="editStudentModal"
  tabindex="-1"
  aria-labelledby="editStudentModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content border-0">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="editStudentModalLabel">Edit Student</h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>

      <div class="modal-body">
        <!-- Modal Notification area -->
        <div
          id="modal-notification"
          class="alert d-none mb-3"
          role="alert"
        ></div>

        <form id="edit-student-form">
          <input type="hidden" id="edit-nsn" />

          <div class="mb-3">
            <label for="edit-first-name" class="form-label">First Name</label>
            <input
              type="text"
              class="form-control"
              id="edit-first-name"
              required
            />
          </div>

          <div class="mb-3">
            <label for="edit-last-name" class="form-label">Last Name</label>
            <input
              type="text"
              class="form-control"
              id="edit-last-name"
              required
            />
          </div>

          <div class="mb-3">
            <label for="edit-preferred-name" class="form-label"
              >Preferred Name</label
            >
            <input type="text" class="form-control" id="edit-preferred-name" />
          </div>

          <div class="mb-3">
            <label for="edit-ethnicity" class="form-label">Ethnicity</label>
            <select class="form-select" id="edit-ethnicity">
              {% for eth in ethnicities %}
              <option value="{{ eth.id }}">{{ eth.desc }}</option>
              {% endfor %}
            </select>
          </div>

          <button type="submit" class="btn btn-primary" id="save-btn">
            Save Changes
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  const searchInput = document.getElementById("search-input");
  const resultsList = document.getElementById("results");
  const sortSelect = document.getElementById("sort-select");

  let debounceTimer;

  function showNotification(message, type = "success") {
    const notif = document.getElementById("notification");
    notif.className = `alert alert-${type}`;
    notif.textContent = message;
    notif.classList.remove("d-none");
    setTimeout(() => notif.classList.add("d-none"), 3000);
  }

  function showModalNotification(message, type = "success") {
    const notif = document.getElementById("modal-notification");
    notif.className = `alert alert-${type} mb-3`;
    notif.textContent = message;
    notif.classList.remove("d-none");
  }

  function clearModalNotification() {
    const notif = document.getElementById("modal-notification");
    notif.classList.add("d-none");
    notif.textContent = "";
  }

  function sortStudents(data, sortOption) {
    const [key, direction] = sortOption.split("_");
    return data.sort((a, b) => {
      if (a[key] < b[key]) return direction === "asc" ? -1 : 1;
      if (a[key] > b[key]) return direction === "asc" ? 1 : -1;
      return 0;
    });
  }

  function renderStudents(data) {
    resultsList.innerHTML = "";

    if (!Array.isArray(data) || data.length === 0) {
      resultsList.innerHTML =
        '<div class="col-12"><div class="alert alert-warning">No students found.</div></div>';
      return;
    }

    const sorted = sortStudents(data, sortSelect.value);

    sorted.forEach((student) => {
      const col = document.createElement("div");
      col.className = "col-md-6 col-lg-4";

      col.innerHTML = `
        <div class="card border-2 d-flex flex-column justify-content-between" style="border-color: #1a427d; height: 100%;">
          <div class="card-body d-flex flex-column">
            <h5 class="card-title">
              ${student.FirstName} ${student.LastName}
              ${
                student.PreferredName
                  ? `<small class="text-muted">(${student.PreferredName})</small>`
                  : ""
              }
            </h5>
            <p class="card-text mb-1"><strong>DOB:</strong> ${
              student.DateOfBirth ?? ""
            }</p>
            <p class="card-text mb-1"><strong>Ethnicity:</strong> ${
              student.EthnicityDesc ?? ""
            }</p>
            <p class="card-text mb-1"><strong>Year Level:</strong> ${
              student.YearLevelID ?? ""
            }
              (Term ${student.Term ?? ""}, ${student.CalendarYear ?? ""})
            </p>
            <p class="card-text mb-3"><strong>NSN:</strong> ${
              student.NSN ?? ""
            }</p>

            <div class="mt-auto d-flex justify-content-end">
              <button class="btn btn-primary btn-sm text-white edit-btn"
                      data-nsn="${student.NSN ?? ""}"
                      data-first="${student.FirstName ?? ""}"
                      data-last="${student.LastName ?? ""}"
                      data-pref="${student.PreferredName ?? ""}"
                      data-ethnicity="${student.EthnicityID ?? ""}">
                ✏️ Edit
              </button>
            </div>
          </div>
        </div>
      `;

      resultsList.appendChild(col);
    });
  }

  function fetchStudents(query) {
    return fetch(
      `/Students/search?q=${encodeURIComponent(query)}&t=${Date.now()}`
    )
      .then((response) => response.json())
      .then((data) => {
        renderStudents(data);
        return data; // return for callers that want to re-use it
      });
  }

  function populateModalFromStudent(student) {
    document.getElementById("edit-nsn").value = student.NSN ?? "";
    document.getElementById("edit-first-name").value = student.FirstName ?? "";
    document.getElementById("edit-last-name").value = student.LastName ?? "";
    document.getElementById("edit-preferred-name").value =
      student.PreferredName ?? "";
    document.getElementById("edit-ethnicity").value = student.EthnicityID ?? "";
  }

  // Re-load the modal fields from the server data (ensures persisted values)
  async function reloadModalFromServerByNSN(nsn) {
    const query = searchInput.value.trim();
    if (query.length < 2) return false;

    const data = await fetch(
      `/Students/search?q=${encodeURIComponent(query)}&t=${Date.now()}`
    ).then((r) => r.json());

    renderStudents(data);

    const updated = Array.isArray(data)
      ? data.find((s) => String(s.NSN) === String(nsn))
      : null;
    if (updated) {
      populateModalFromStudent(updated);
      return true;
    }
    return false;
  }

  searchInput.addEventListener("input", () => {
    clearTimeout(debounceTimer);
    const query = searchInput.value.trim();
    if (query.length < 2) {
      resultsList.innerHTML = "";
      return;
    }
    debounceTimer = setTimeout(() => {
      fetchStudents(query).catch((err) => {
        console.error("❌ Error fetching students:", err);
        showNotification("❌ Search failed.", "danger");
      });
    }, 800);
  });

  sortSelect.addEventListener("change", () => {
    const query = searchInput.value.trim();
    if (query.length >= 2) {
      fetchStudents(query).catch((err) => {
        console.error("❌ Error fetching students:", err);
        showNotification("❌ Search failed.", "danger");
      });
    }
  });

  document.addEventListener("click", function (e) {
    const btn = e.target.closest(".edit-btn");
    if (!btn) return;

    clearModalNotification();

    populateModalFromStudent({
      NSN: btn.dataset.nsn,
      FirstName: btn.dataset.first,
      LastName: btn.dataset.last,
      PreferredName: btn.dataset.pref,
      EthnicityID: btn.dataset.ethnicity,
    });

    const modal = new bootstrap.Modal(
      document.getElementById("editStudentModal")
    );
    modal.show();
  });

  document
    .getElementById("editStudentModal")
    .addEventListener("hidden.bs.modal", () => {
      clearModalNotification();
      // put button text back just in case
      const saveBtn = document.getElementById("save-btn");
      saveBtn.disabled = false;
      saveBtn.textContent = "Save Changes";
    });

  document
    .getElementById("edit-student-form")
    .addEventListener("submit", async function (e) {
      e.preventDefault();

      clearModalNotification();

      const saveBtn = document.getElementById("save-btn");
      saveBtn.disabled = true;
      saveBtn.textContent = "Saving changes…";

      const nsn = document.getElementById("edit-nsn").value;

      const payload = {
        NSN: nsn,
        FirstName: document.getElementById("edit-first-name").value,
        LastName: document.getElementById("edit-last-name").value,
        PreferredName: document.getElementById("edit-preferred-name").value,
        EthnicityID: document.getElementById("edit-ethnicity").value,
      };

      try {
        const resp = await fetch("/Students/edit", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        let body;
        const ct = resp.headers.get("content-type") || "";
        if (ct.includes("application/json")) {
          body = await resp.json();
        } else {
          const txt = await resp.text();
          body = {
            success: false,
            message: `Non-JSON response (${resp.status}). ${txt.slice(0, 200)}`,
          };
        }

        if (!resp.ok || !body.success) {
          showModalNotification(
            `❌ Update failed: ${body.message || `HTTP ${resp.status}`}`,
            "danger"
          );
          saveBtn.disabled = false;
          saveBtn.textContent = "Save Changes";
          return;
        }

        // Re-load from server and show persisted values in the modal
        const found = await reloadModalFromServerByNSN(nsn);

        showModalNotification(
          found
            ? "✅ Updated successfully"
            : "✅ Updated successfully (but couldn’t re-load the updated row)",
          "success"
        );

        // Keep the modal open (so user sees success + confirmed fields)
        // Button returns to normal state
        saveBtn.disabled = false;
        saveBtn.textContent = "Save Changes";

        // Also show a page notification if you want
        showNotification("✅ Student updated!", "success");
      } catch (err) {
        console.error("❌ Error:", err);
        showModalNotification("❌ Unexpected error", "danger");
        saveBtn.disabled = false;
        saveBtn.textContent = "Save Changes";
      }
    });
</script>

{% endblock %}
