<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <title>{% block title %}{% endblock %}</title>

    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <!-- Bootstrap Select -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta2/dist/css/bootstrap-select.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta2/dist/js/bootstrap-select.min.js"></script>

    <!-- Bootstrap Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />

    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/custom.css') }}"
    />

    <style>
      /* page content already uses padding-top; add anchor + modal safety */
      html { scroll-padding-top: calc(var(--navbar-h) + env(safe-area-inset-top, 0px)); }

      /* BS5 lets us control modal top margin with a var */
      .modal { --bs-modal-margin: calc(var(--navbar-h) + 1rem); }

      html, body { height: 100%; }

      /* Reserve space for navbar */
      :root { --navbar-h: 56px; }

      body {
        position: relative;
        min-height: 100%;
      }

      /* ✅ Fixed full-screen background */
      body::before {
        content: "";
        position: fixed;
        inset: 0;
        z-index: -1;
        background: url("{{ url_for('static', filename='background.svg') }}")
          no-repeat center bottom / cover;
        transform: translateZ(0);
      }

      /* Mobile fix for iOS & Chrome */
      @media (max-width: 575.98px) {
        body::before {
          height: 100dvh;
          background-attachment: scroll;
        }
      }

      /* Navbar */
      .navbar.fixed-top {
        padding-top: env(safe-area-inset-top, 0px);
        z-index: 1080;
        backdrop-filter: saturate(120%) blur(6px);
      }

      .custom-navbar {
        background: rgba(26, 66, 125, 0.92);
      }

      /* Main content */
      main {
        min-height: calc(100vh - var(--navbar-h) - env(safe-area-inset-top, 0px));
        display: flex;
        flex-direction: column;
      }

      /* Uniform buttons */
      .uniform-btn {
        min-width: 110px;
        text-align: center;
      }

      /* Collapsed navbar tweaks */
      @media (max-width: 991.98px) {
        .navbar .navbar-nav {
          align-items: flex-start;
        }
        .navbar .uniform-btn {
          width: auto !important;
          display: inline-flex;
        }
        .navbar .nav-link {
          width: auto;
        }
      }
    </style>

    {% block head %}{% endblock %}
  </head>

  <body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark custom-navbar py-2 fixed-top">
      <div class="container-fluid px-2 px-sm-3">
        <a
          class="navbar-brand d-flex align-items-center"
          href="{{ url_for('home_bp.home') }}"
          aria-label="Home"
        >
          <img
            src="{{ url_for('static', filename='LightLogo.png') }}"
            alt="Water Skills for Life — Home"
            class="img-fluid"
            style="height: 40px; margin-right: 12px"
          />
        </a>

        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
          aria-controls="navbarNav"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>

        {% if user_role in ["ADM", "PRO", "MOE", "FUN", "GRP"] %}
        <div class="collapse navbar-collapse mt-2 mt-lg-0" id="navbarNav">
          <ul class="navbar-nav ms-auto align-items-lg-center">
            <!-- Dashboard -->
            <li class="nav-item">
              <a
                class="nav-link {% if request.path == '/' %}active{% endif %}"
                {% if request.path == '/' %}aria-current="page"{% endif %}
                href="{{ url_for('home_bp.home') }}"
              >Dashboard</a>
            </li>

            {% if user_role == "GRP" %}
            <li class="nav-item dropdown">
              <a
                id="grpToolsToggle"
                class="nav-link dropdown-toggle"
                href="#"
                role="button"
                aria-haspopup="true"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >Provider Tools</a>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="grpToolsToggle">
                <li><a class="dropdown-item py-2" href="{{ url_for('funder_bp.funder_dashboard') }}">Overview</a></li>
                <li><a class="dropdown-item py-2" href="{{ url_for('report_bp.new_reports') }}">Reporting</a></li>
                <li><a class="dropdown-item py-2" href="{{ url_for('class_bp.funder_classes') }}">Class Lookup</a></li>
              </ul>
            </li>
            {% endif %}

            {% if user_role == "FUN" %}
            <li class="nav-item dropdown">
              <a
                id="funToolsToggle"
                class="nav-link dropdown-toggle"
                href="#"
                role="button"
                aria-haspopup="true"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >Funder Tools</a>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="funToolsToggle">
                {% if session['user_admin'] == 1 %}
                <li><a class="dropdown-item py-2" href="{{ url_for('funder_bp.funder_dashboard') }}">Overview</a></li>
                {% endif %}
                <li><a class="dropdown-item py-2" href="{{ url_for('report_bp.new_reports') }}">Reporting</a></li>
                <li><a class="dropdown-item py-2" href="{{ url_for('class_bp.funder_classes') }}">Class Lookup</a></li>
                {% if session['user_admin'] == 1 %}
                <li><a class="dropdown-item py-2" href="{{ url_for('admin_bp.provider_maintenance') }}">Provider Maintenance</a></li>
                {% endif %}
                <li><a class="dropdown-item py-2" href="{{ url_for('class_bp.achievement_upload') }}">Upload Student Achievements</a></li>
              </ul>
            </li>
            {% endif %}

            {% if user_role == "MOE" %}
            <li class="nav-item dropdown">
              <a
                id="moeToolsToggle"
                class="nav-link dropdown-toggle {% if 'school' in request.path or 'classlistupload' in request.path %}active{% endif %}"
                href="#"
                role="button"
                aria-haspopup="true"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >School Tools</a>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="moeToolsToggle">
                {% if session['user_admin'] == 1 %}
                <li><a class="dropdown-item py-2" href="{{ url_for('funder_bp.funder_dashboard') }}">Overview</a></li>
                <li><a class="dropdown-item py-2" href="{{ url_for('report_bp.new_reports') }}">Reporting</a></li>
                <li><a class="dropdown-item py-2" href="{{ url_for('class_bp.class_students_page') }}">Edit Class Lists</a></li>
                {% endif %}
                <li>
                  <a class="dropdown-item py-2"
                     href="{% if user_role == 'ADM' %}{{ url_for('class_bp.funder_classes') }}{% else %}{{ url_for('class_bp.moe_classes') }}{% endif %}">
                    Class Lookup
                  </a>
                </li>
                <li><a class="dropdown-item py-2" href="{{ url_for('upload_bp.classlistupload') }}">Upload Class List</a></li>
                {% if session['user_admin'] == 1 %}
                <li><a class="dropdown-item py-2" href="{{ url_for('students_bp.student_search_page') }}">Edit Student Record</a></li>
                {% endif %}
              </ul>
            </li>
            {% endif %}

            {% if user_role == "PRO" %}
            <li class="nav-item dropdown">
              <a
                id="proToolsToggle"
                class="nav-link dropdown-toggle {% if 'reporting' in request.path or 'provider_classes' in request.path %}active{% endif %}"
                href="#"
                role="button"
                aria-haspopup="true"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >Provider Tools</a>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="proToolsToggle">
                {% if session['user_admin'] == 1 %}
                <li><a class="dropdown-item py-2" href="{{ url_for('funder_bp.funder_dashboard') }}">Overview</a></li>
                {% endif %}
                <li><a class="dropdown-item py-2" href="{{ url_for('report_bp.new_reports') }}">Reporting</a></li>
                <li><a class="dropdown-item py-2" href="{{ url_for('class_bp.provider_classes') }}">Class Lookup</a></li>
                <li><a class="dropdown-item py-2" href="{{ url_for('class_bp.achievement_upload') }}">Upload Student Achievements</a></li>
              </ul>
            </li>
            {% endif %}

            {% if user_role == "ADM" and user_email != "megan@watersafety.org.nz" %}
            <li class="nav-item dropdown">
              <a
                id="admToolsToggle"
                class="nav-link dropdown-toggle {% if 'reporting' in request.path or 'classlistupload' in request.path or 'funder_classes' in request.path %}active{% endif %}"
                href="#"
                role="button"
                aria-haspopup="true"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >Admin Tools</a>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="admToolsToggle">
                <li><h6 class="dropdown-header">Reports &amp; Dashboards</h6></li>
                <li><a class="dropdown-item py-2" href="{{ url_for('report_bp.new_reports') }}">Reporting</a></li>
                <li><a class="dropdown-item py-2" href="{{ url_for('funder_bp.funder_dashboard') }}">Overview by Entity</a></li>
                <li><a class="dropdown-item py-2" href="{{ url_for('funder_bp.admin_dashboard') }}">Overview</a></li>

                <li><hr class="dropdown-divider" /></li>

                <li><h6 class="dropdown-header">Entity &amp; User Management</h6></li>
                <li><a class="dropdown-item py-2" href="{{ url_for('admin_bp.admin_user_entities') }}">Edit User Entity</a></li>
                <li><a class="dropdown-item py-2" href="{{ url_for('add_user.add_user') }}">Add Teacher</a></li>
                <li><a class="dropdown-item py-2" href="{{ url_for('admin_bp.provider_maintenance') }}">Provider Maintenance</a></li>
                <li><a class="dropdown-item py-2" href="{{ url_for('admin_bp.edit_school_type') }}">Edit School Type</a></li>
                <li><a class="dropdown-item py-2" href="{{ url_for('students_bp.student_search_page') }}">Edit Student Record</a></li>
                <li><a class="dropdown-item py-2" href="{{ url_for('class_bp.class_students_page') }}">Edit Class Lists</a></li>

                <li><hr class="dropdown-divider" /></li>

                <li><h6 class="dropdown-header">Data Uploads &amp; Lookup</h6></li>
                <li><a class="dropdown-item py-2" href="{{ url_for('upload_bp.classlistupload') }}">Upload Class List</a></li>
                <li><a class="dropdown-item py-2" href="{{ url_for('eLearning_bp.admin_eLearning_upload') }}">Upload eLearning Excel</a></li>
                <li><a class="dropdown-item py-2" href="{{ url_for('class_bp.funder_classes') }}">Class Lookup</a></li>
                <li><a class="dropdown-item py-2" href="{{ url_for('class_bp.achievement_upload') }}">Upload Student Achievements</a></li>
              </ul>
            </li>
            {% elif user_role == "ADM" and user_email == "megan@watersafety.org.nz" %}
            <li class="nav-item dropdown">
              <a
                id="admToolsMeganToggle"
                class="nav-link dropdown-toggle {% if 'reporting' in request.path or 'classlistupload' in request.path or 'funder_classes' in request.path %}active{% endif %}"
                href="#"
                role="button"
                aria-haspopup="true"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >Admin Tools</a>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="admToolsMeganToggle">
                <li><a class="dropdown-item py-2" href="{{ url_for('report_bp.new_reports') }}">Reporting</a></li>
                <li><a class="dropdown-item py-2" href="{{ url_for('funder_bp.funder_dashboard') }}">Overview by Entity</a></li>
                <li><a class="dropdown-item py-2" href="{{ url_for('funder_bp.admin_dashboard') }}">Overview</a></li>
                <li><a class="dropdown-item py-2" href="{{ url_for('survey_bp.survey_by_routename', routename='ExternalReview') }}">Complete an External Review</a></li>
                <li><a class="dropdown-item py-2" href="{{ url_for('survey_bp.list_my_surveys') }}">View Past Forms</a></li>
              </ul>
            </li>
            {% endif %}

            {% if user_email != "megan@watersafety.org.nz" %}
            <li class="nav-item dropdown mt-2 mt-lg-0 me-2">
              <a
                id="formsToggle"
                class="nav-link dropdown-toggle"
                href="#"
                role="button"
                aria-haspopup="true"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              ><i class="bi bi-ui-checks me-1"></i> Forms</a>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="formsToggle">
                <li><a class="dropdown-item py-2" href="{{ url_for('survey_bp.survey_by_routename', routename='SelfReview') }}">Complete a Self Review</a></li>
                {% if user_role == "ADM" %}
                <li><a class="dropdown-item py-2" href="{{ url_for('survey_bp.survey_by_routename', routename='ExternalReview') }}">Complete an External Review</a></li>
                {% endif %}
                {% if user_role in ["FUN", "ADM"] %}
                <li><a class="dropdown-item py-2" href="{{ url_for('survey_bp.survey_by_routename', routename='TeacherAssessment') }}">Complete a Teacher Assessment</a></li>
                {% endif %}
                {% if user_admin == 1 %}
                <li><a class="dropdown-item py-2" href="{{ url_for('survey_bp.staff_survey_admin') }}">View Staff Forms</a></li>
                {% endif %}
                <li><a class="dropdown-item py-2" href="{{ url_for('survey_bp.list_my_surveys') }}">View Past Forms</a></li>
                {% if user_email == "stella@watersafety.org.nz" %}
                <li><a class="dropdown-item py-2" href="{{ url_for('survey_bp.survey_builder') }}">Form Builder</a></li>
                {% endif %}
                <li><hr class="dropdown-divider" /></li>
                <li><a class="dropdown-item py-2" href="{{ url_for('feedback_bp.feedback') }}">Report an Issue / Submit Feedback</a></li>
              </ul>
            </li>
            {% endif %}

            {% if session['user_admin'] == 1 %}
            <li class="nav-item dropdown mt-2 mt-lg-0 me-2">
              <a
                id="staffToggle"
                class="nav-link dropdown-toggle"
                href="#"
                role="button"
                aria-haspopup="true"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              ><i class="bi bi-people-fill me-1"></i> Staff</a>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="staffToggle">
                {% if user_email != "megan@watersafety.org.nz" %}
                <li><a class="dropdown-item py-2" href="{{ url_for('staff_bp.staff_maintenance') }}">Manage My Staff</a></li>
                {% endif %}
                {% if user_role != "MOE" %}
                <li><a class="dropdown-item py-2" href="{{ url_for('survey_bp.staff_survey_admin') }}">View Staff Forms</a></li>
                <li><a class="dropdown-item py-2" href="{{ url_for('staff_bp.staff_eLearning') }}">View All eLearnings</a></li>
                {% endif %}
              </ul>
            </li>
            {% endif %}

            {% if user_email != "megan@watersafety.org.nz" %}
            <li class="nav-item mt-2 mt-lg-0 me-2">
              <a href="{{ url_for('eLearning_bp.eLearning_guide') }}" class="nav-link">eLearning</a>
            </li>
            <li class="nav-item mt-2 mt-lg-0 me-2">
              <a href="{{ url_for('admin_bp.create_user') }}" class="nav-link">
                <i class="bi bi-person-plus me-1"></i> Create User
              </a>
            </li>
            <li class="nav-item mt-2 mt-lg-0 me-2">
              <a class="nav-link" href="{{ url_for('upload_bp.classlistupload') }}">Upload Class List</a>
            </li>
            {% endif %}

            <!-- Action buttons -->
            <li class="nav-item mt-2 mt-lg-0 me-2">
              <a
                href="{{ url_for('instructions_bp.instructions_me') }}"
                class="btn btn-outline-light btn-sm d-flex justify-content-center align-items-center text-center uniform-btn"
              >
                <i class="bi bi-question-circle me-1"></i> Help
              </a>
            </li>

            <li class="nav-item mt-2 mt-lg-0 me-2">
              <a
                href="{{ url_for('admin_bp.profile') }}"
                class="btn btn-outline-light btn-sm d-flex justify-content-center align-items-center text-center uniform-btn"
              >
                <i class="bi bi-person-fill me-1"></i> Profile
              </a>
            </li>

            <li class="nav-item mt-2 mt-lg-0">
              <form action="{{ url_for('auth_bp.logout') }}" method="post" class="d-inline">
                <button
                  type="submit"
                  class="btn btn-outline-light btn-sm d-flex justify-content-center align-items-center text-center uniform-btn"
                >
                  <i class="bi bi-box-arrow-right me-1"></i> Logout
                </button>
              </form>
            </li>
          </ul>
        </div>
        {% endif %}
      </div>
    </nav>

    <div id="nav-spacer" style="height: var(--navbar-h);"></div>

    <!-- Main Content -->
    <main class="container-fluid px-2 py-4">
      {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
      <div class="container mt-3">
        {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
      </div>
      {% endif %}
      {% endwith %}

      {% block content %}{% endblock %}
    </main>

    <!-- JS (order matters: Bootstrap first, then our script that uses its events) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Update --navbar-h on load/resize/collapse -->
    <script>
      (function () {
        const nav = document.querySelector('.navbar.fixed-top, .navbar.sticky-top') || document.querySelector('.navbar');
        if (!nav) return;

        const setNavbarHeightVar = () => {
          const h = Math.ceil(nav.getBoundingClientRect().height || 56);
          document.documentElement.style.setProperty('--navbar-h', `${h}px`);
        };

        // run early & often
        setNavbarHeightVar();
        window.addEventListener('load', setNavbarHeightVar, { passive: true });
        window.addEventListener('resize', setNavbarHeightVar, { passive: true });
        document.addEventListener('shown.bs.collapse', setNavbarHeightVar);
        document.addEventListener('hidden.bs.collapse', setNavbarHeightVar);

        // watch for height changes (e.g., wrapping text, dynamic menus)
        const mo = new ResizeObserver(setNavbarHeightVar);
        mo.observe(nav);
      })();
    </script>

    {% block scripts %}{% endblock %}
  </body>
</html>
