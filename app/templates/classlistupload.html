{% extends "header.html" %}

{% block title %}Class Upload{% endblock %}

{% block content %}
<div class="container mt-5">
 <h2 class="text-center text-primary mb-4">Upload Class List</h2>

 <form id="upload-form" action="{{ url_for('upload_bp.classlistupload') }}"
       method="post" enctype="multipart/form-data" class="row g-3">

   <!-- Funder -->
   <div class="col-md-6">
     <label for="funder" class="form-label">Funder</label>
     <select id="funder" name="funder" class="form-select" required>
       <option value="">Select a funder</option>
       {% for funder in funders %}
         <option value="{{ funder.FunderID }}"
                 {% if selected_funder == funder.FunderID %}selected{% endif %}>
           {{ funder.Description }}
         </option>
       {% endfor %}
     </select>
   </div>

   <!-- School -->
   <div class="col-md-6">
     <label class="form-label">School</label>
     {% if user_role == 'MOE' %}
       <!-- Show as read-only text and submit via hidden field -->
       <input type="text" class="form-control-plaintext"
              value="{{ selected_school or 'â€”' }}" readonly>
       <input type="hidden" id="school_hidden" name="school"
              value="{{ selected_school }}">
     {% else %}
       <select class="form-select" id="school" name="school" required>
         <option selected disabled value="">Select a school</option>
         {% for name in schools %}
           <option value="{{ name }}"
                   {% if selected_school == name %}selected{% endif %}>
             {{ name }}
           </option>
         {% endfor %}
       </select>
     {% endif %}
   </div>

   <!-- Term -->
   <div class="col-md-2">
     <label for="term" class="form-label">Term</label>
     <select class="form-select" id="term" name="term" required>
       {% set default_term = selected_term if selected_term else '2' %}
       {% for t in [1,2,3,4] %}
         <option value="{{ t }}"
                 {% if default_term == t|string %}selected{% endif %}>
           Term {{ t }}
         </option>
       {% endfor %}
     </select>
   </div>

   <!-- Year -->
   <div class="col-md-1">
     <label for="year" class="form-label">Year</label>
     <select class="form-select" id="year" name="year" required>
       {% set default_year = selected_year if selected_year else 2025 %}
       {% for y in range(2023, 2026) %}
         <option value="{{ y }}"
                 {% if default_year == y %}selected{% endif %}>
           {{ y }}
         </option>
       {% endfor %}
     </select>
   </div>

   <!-- Teacher / Class -->
   <div class="col-md-3">
     <label for="teachername" class="form-label">Teacher Name</label>
     <input type="text" class="form-control" id="teachername" name="teachername"
            value="{{ selected_teacher | default('', true) | e }}" required>
   </div>

   <div class="col-md-3">
     <label for="classname" class="form-label">Class Name</label>
     <input type="text" class="form-control" id="classname" name="classname"
            value="{{ selected_class | default('', true) | e }}" required>
   </div>

   <!-- File upload -->
   <div class="col-md-3">
     <label for="csv_file" class="form-label">Upload CSV File</label>
     <input type="file" class="form-control" id="csv_file" name="csv_file"
            accept=".csv, .xls, .xlsx, .xlsm"
            {% if not preview_data %}required{% endif %}>
   </div>

   <div class="form-check">
     <input class="form-check-input" type="checkbox" id="no_headers"
            name="no_headers"
            {% if request.form.get('no_headers') %}checked{% endif %}>
     <label class="form-check-label" for="no_headers">File has no headers</label>
   </div>

   <input type="hidden" id="column_mappings" name="column_mappings">

   <div class="col-12 d-flex gap-3" id="action-button-container">
     <div id="preview-button-container" style="display:none;">
       <button type="submit" name="action" value="preview"
               class="btn btn-secondary">Preview File</button>
     </div>
     {% if preview_data and not validated %}
       <button type="submit" name="action" value="validate" id="validate-button"
               class="btn btn-success">Validate Data</button>
     {% endif %}
   </div>
 </form>

 {% if preview_data %}
   <!-- your existing preview/validated table section remains unchanged -->
   {{ super() }}
 {% endif %}

 <!-- Validation error modal (unchanged) -->
 <div class="modal fade" id="validationErrorModal" tabindex="-1"
      aria-labelledby="validationErrorModalLabel" aria-hidden="true">
   <div class="modal-dialog">
     <div class="modal-content border-danger">
       <div class="modal-header bg-danger text-white">
         <h5 class="modal-title" id="validationErrorModalLabel">Missing Required Columns</h5>
         <button type="button" class="btn-close btn-close-white"
                 data-bs-dismiss="modal" aria-label="Close"></button>
       </div>
       <div class="modal-body">
         Please assign columns for:
         <ul>
           <li><strong>NSN</strong></li>
           <li><strong>LastName</strong></li>
           <li><strong>FirstName</strong> or <strong>PreferredName</strong></li>
         </ul>
         before validating the data.
       </div>
       <div class="modal-footer">
         <button type="button" class="btn btn-secondary"
                 data-bs-dismiss="modal">Close</button>
       </div>
     </div>
   </div>
 </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  const userRole = "{{ user_role|e }}";
  const funderEl  = document.getElementById("funder");
  const schoolSel = document.getElementById("school");

  // Only repopulate schools for non-MOE users
  funderEl?.addEventListener("change", function () {
    if (userRole === "MOE") return;
    fetch(`/get_schools_for_funder?funder_id=${this.value}`)
      .then(res => res.json())
      .then(data => {
        if (!schoolSel) return;
        schoolSel.innerHTML = '<option value="">Select a school</option>';
        data.forEach(s => {
          const opt = document.createElement("option");
          opt.value = s;
          opt.textContent = s;
          schoolSel.appendChild(opt);
        });
      });
  });

  // Column mapping logic (unchanged)
  const selects = document.querySelectorAll('select[name^="map_"]');
  const stored = localStorage.getItem("column_mappings");
  if (stored) {
    const map = JSON.parse(stored);
    selects.forEach(s => {
      const key = s.getAttribute("data-remember");
      if (map[key]) s.value = map[key];
    });
  }

  function updateMappingOptions() {
    const used = Array.from(selects).map(s => s.value).filter(Boolean);
    selects.forEach(select => {
      const current = select.value;
      Array.from(select.options).forEach(opt => {
        if (!opt.value || opt.value === current) return;
        opt.disabled = used.includes(opt.value);
      });
    });
  }
  selects.forEach(s => s.addEventListener("change", updateMappingOptions));
  updateMappingOptions();

  document.getElementById("upload-form").addEventListener("submit", () => {
    const mapping = {};
    selects.forEach(s => {
      const col = s.name.replace("map_", "");
      if (s.value) mapping[col] = s.value;
    });
    document.getElementById("column_mappings").value = JSON.stringify(mapping);
    localStorage.setItem("column_mappings", JSON.stringify(mapping));
  });

  const fileInput = document.getElementById("csv_file");
  const previewContainer = document.getElementById("preview-button-container");
  fileInput.addEventListener("change", () => {
    previewContainer.style.display = fileInput.files.length > 0 ? "block" : "none";
  });

  const validateButton = document.getElementById("validate-button");
  if (validateButton) {
    validateButton.addEventListener("click", (e) => {
      const mappings = {};
      selects.forEach(s => {
        const col = s.name.replace("map_", "");
        mappings[s.value] = col;
      });

      const hasNSN = mappings.hasOwnProperty("NSN");
      const hasLastName = mappings.hasOwnProperty("LastName");
      const hasFirstOrPreferred =
        mappings.hasOwnProperty("FirstName") || mappings.hasOwnProperty("PreferredName");

      if (!(hasNSN && hasLastName && hasFirstOrPreferred)) {
        e.preventDefault();
        const modal = new bootstrap.Modal(
          document.getElementById("validationErrorModal")
        );
        modal.show();
      } else {
        validateButton.style.display = "none";
        const postButtons = document.getElementById("post-validate-buttons");
        if (postButtons) postButtons.style.display = "flex";
      }
    });
  }
});
</script>
{% endblock %}
