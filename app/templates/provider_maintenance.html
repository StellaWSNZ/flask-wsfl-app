{# templates/provider_maintenance.html #}
{% extends "header.html" %}
{% block title %}Provider Maintenance{% endblock %}

{% block content %}
<h3 class="mb-4 text-center text-primary">Provider Maintenance</h3>

{% if selected_funder %}
  <div class="text-center mb-4">
    Providers with errors?
    <a href="{{ url_for('admin_bp.manage_providers', funder_id=selected_funder) }}"><strong>Click here to edit</strong></a>
  </div>
{% endif %}

<!-- Filter Form -->
<form method="POST" class="row justify-content-center g-3 mb-4">
  {% if user_role == 'ADM' %}
    <div class="col-md-3">
      <label for="funder" class="form-label">Funder</label>
      <select id="funder" name="funder" class="form-select" required>
        {% if not selected_funder %}
          <option value="" disabled selected>Pick a funder...</option>
        {% endif %}
        {% for f in funders %}
          <option value="{{ f['id'] }}" {% if selected_funder == f['id'] %}selected{% endif %}>
            {{ f['Description'] }}
          </option>
        {% endfor %}
      </select>
    </div>
  {% endif %}

  <div class="col-md-2">
    <label for="term" class="form-label">Term</label>
    <select id="term" name="term" class="form-select" required>
      {% for t in terms %}
        <option value="{{ t }}" {% if selected_term == t %}selected{% endif %}>Term {{ t }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="col-md-2">
    <label for="year" class="form-label">Year</label>
    <select id="year" name="year" class="form-select" required>
      {% for y in years %}
        <option value="{{ y }}" {% if selected_year == y %}selected{% endif %}>{{ y }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="col-md-auto d-flex align-items-end">
    <button type="submit" class="btn btn-primary">Show Schools</button>
  </div>
</form>

<style>
  thead.custom-header th {
    background-color: #004080 !important;
    color: white !important;
    border-color: #004080 !important;
    text-align: center;
  }
</style>

{% if schools %}

<!-- ========================= -->
<!-- Desktop table (>= sm)     -->
<!-- ========================= -->
<div class="d-none d-sm-block">
  <div class="container">
    <table class="table table-bordered table-hover align-middle">
      <thead class="custom-header">
        <tr>
          <th>School Name</th>
          <th>Total Classes</th>
          <th>Total Students</th>
          <th>Equity Index</th>
          <th>Year Levels</th>
          <th>Assign Provider</th>
        </tr>
      </thead>

      <tbody>
        {% for school in schools %}
          <tr>
            <td>{{ school.School }}</td>
            <td class="text-center">{{ school.TotalClasses }}</td>
            <td class="text-center">{{ school.TotalStudents }}</td>
            <td class="text-center">{{ school.EquityIndex }}</td>
            <td>{{ school.DistinctYearLevels }}</td>

            <td>
              <div class="provider-scope"
                   data-is-clm="{{ 1 if is_swimmagic_clm else 0 }}"
                   data-current-provider1id="{{ school.Provider1ID or '' }}"
                   data-current-provider2id="{{ school.Provider2ID or '' }}">

                <!-- Provider 1 select (Kaiako-led OR normal single-provider) -->
                <div class="input-group input-group-sm">
                  <select class="form-select provider-select"
                          data-moe="{{ school.MOENumber }}"
                          data-term="{{ selected_term }}"
                          data-year="{{ selected_year }}"
                          data-funder="{{ selected_funder }}">
                    <option value="">Not chosen</option>

                    {% for provider in providers %}
                      {% set provider_is_kaiako = 'kaiako' in (provider.Description|lower) %}
                      <option value="{{ provider.ProviderID }}"
                        {% if school.Provider1ID and (school.Provider1ID|int == provider.ProviderID) %}
                          selected
                        {% endif %}>
                        {% if provider_is_kaiako and selected_funder_name %}
                          Kaiako led ({{ selected_funder_name }})
                        {% elif provider_is_kaiako %}
                          Kaiako led
                        {% else %}
                          {{ provider.Description }}
                        {% endif %}
                      </option>
                    {% endfor %}
                  </select>

                  <button type="button"
                          class="btn btn-outline-secondary add-provider-btn"
                          data-bs-toggle="modal"
                          data-bs-target="#newProviderModal"
                          aria-label="Add new provider">
                    <i class="bi bi-plus-lg" aria-hidden="true"></i>
                  </button>
                </div>

                <!-- CLM MODE: Provider 2 (Facility) + Facility staff -->
                <div class="mt-2 clm-wrapper d-none">
                  <label class="form-label small mb-1">Select CLM facility</label>
                  <div class="input-group input-group-sm mb-2">
                    <select class="form-select clm-facility-select"
                            data-moe="{{ school.MOENumber }}"
                            data-term="{{ selected_term }}"
                            data-year="{{ selected_year }}"
                            data-funder="{{ selected_funder }}">
                      <option value="">Not selected</option>
                      {# options populated by JS from /api/clm_facilities #}
                    </select>
                  </div>

                  <label class="form-label small mb-1">Select facility staff member</label>
                  <div class="input-group input-group-sm">
                    <select class="form-select clm-staff-select"
                            data-moe="{{ school.MOENumber }}"
                            data-term="{{ selected_term }}"
                            data-year="{{ selected_year }}">
                      <option value="">Not Assigned</option>
                      {# options populated by JS from /api/clm_facility_staff #}
                    </select>
                  </div>
                  <div class="form-text">This appears only for SwimMagic CLM Kaiako-led delivery.</div>
                </div>

                <!-- NON-CLM: Kaiako staff dropdown (funder staff) -->
                <div class="mt-2 staff-dropdown-wrapper d-none">
                  <label class="form-label small mb-1">Assign Kaiako Staff</label>
                  <div class="input-group input-group-sm">
                    <select class="form-select funder-staff-select"
                            name="staff_email_{{ school.MOENumber }}"
                            data-moe="{{ school.MOENumber }}"
                            data-term="{{ selected_term }}"
                            data-year="{{ selected_year }}">
                      <option value="">Not Assigned</option>
                      {% for staff in staff_list %}
                        <option value="{{ staff.Email }}"
                          {% if school.SelectedStaffEmail == staff.Email %}selected{% endif %}>
                          {{ staff.Name or (staff.FirstName ~ ' ' ~ staff.Surname) }}
                        </option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="form-text">Only required for Kaiako-led delivery.</div>
                </div>

              </div>
            </td>
          </tr>
        {% endfor %}
      </tbody>

    </table>
  </div>
</div>

<!-- ========================= -->
<!-- Mobile cards (< sm)       -->
<!-- ========================= -->
<div class="d-sm-none" id="staffCards">
  {% for school in schools %}
    <div class="card shadow-sm mb-3">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span class="fw-semibold">{{ school.School.split('(')[0].strip() }}</span>
        <small class="text-muted">MOE Number: {{ school.MOENumber }}</small>
      </div>

      <div class="card-body pt-3">
        <ul class="list-group list-group-flush mb-3">
          <li class="list-group-item d-flex justify-content-between">
            <span>Total Classes</span>
            <span class="badge text-bg-primary">{{ school.TotalClasses }}</span>
          </li>
          <li class="list-group-item d-flex justify-content-between">
            <span>Total Students</span>
            <span class="badge text-bg-secondary">{{ school.TotalStudents }}</span>
          </li>
          <li class="list-group-item d-flex justify-content-between">
            <span>Equity Index</span>
            <span class="badge text-bg-info">{{ school.EquityIndex }}</span>
          </li>
          <li class="list-group-item">
            <div class="mb-1">Year Levels</div>
            <div class="small text-muted">{{ school.DistinctYearLevels }}</div>
          </li>
        </ul>

        <div class="provider-scope"
             data-is-clm="{{ 1 if is_swimmagic_clm else 0 }}"
             data-current-provider1id="{{ school.Provider1ID or '' }}"
             data-current-provider2id="{{ school.Provider2ID or '' }}">

          <label class="form-label small mb-1">Assign Provider</label>

          <div class="input-group input-group-sm mb-2">
            <select class="form-select provider-select"
                    data-moe="{{ school.MOENumber }}"
                    data-term="{{ selected_term }}"
                    data-year="{{ selected_year }}"
                    data-funder="{{ selected_funder }}">
              <option value="">Not chosen</option>

              {% for provider in providers %}
                {% set provider_is_kaiako = 'kaiako' in (provider.Description|lower) %}
                <option value="{{ provider.ProviderID }}"
                  {% if school.Provider1ID and (school.Provider1ID|int == provider.ProviderID) %}
                    selected
                  {% endif %}>
                  {% if provider_is_kaiako and selected_funder_name %}
                    Kaiako led ({{ selected_funder_name }})
                  {% elif provider_is_kaiako %}
                    Kaiako led
                  {% else %}
                    {{ provider.Description }}
                  {% endif %}
                </option>
              {% endfor %}
            </select>

            <button type="button"
                    class="btn btn-outline-secondary add-provider-btn"
                    data-bs-toggle="modal"
                    data-bs-target="#newProviderModal"
                    title="Add new provider">
              <i class="bi bi-plus-lg"></i>
            </button>
          </div>

          <!-- CLM mode -->
          <div class="clm-wrapper d-none">
            <label class="form-label small mb-1">Select CLM facility</label>
            <div class="input-group input-group-sm mb-2">
              <select class="form-select clm-facility-select"
                      data-moe="{{ school.MOENumber }}"
                      data-term="{{ selected_term }}"
                      data-year="{{ selected_year }}"
                      data-funder="{{ selected_funder }}">
                <option value="">Not selected</option>
              </select>
            </div>

            <label class="form-label small mb-1">Select facility staff member</label>
            <div class="input-group input-group-sm">
              <select class="form-select clm-staff-select"
                      data-moe="{{ school.MOENumber }}"
                      data-term="{{ selected_term }}"
                      data-year="{{ selected_year }}">
                <option value="">Not Assigned</option>
              </select>
            </div>

            <div class="form-text">This appears only for SwimMagic CLM Kaiako-led delivery.</div>
          </div>

          <!-- Non-CLM Kaiako -->
          <div class="staff-dropdown-wrapper d-none">
            <label class="form-label small mb-1">Assign Kaiako Staff</label>
            <div class="input-group input-group-sm">
              <select class="form-select funder-staff-select"
                      name="staff_email_{{ school.MOENumber }}"
                      data-moe="{{ school.MOENumber }}"
                      data-term="{{ selected_term }}"
                      data-year="{{ selected_year }}">
                <option value="">Not Assigned</option>
                {% for staff in staff_list %}
                  <option value="{{ staff.Email }}"
                    {% if school.SelectedStaffEmail == staff.Email %}selected{% endif %}>
                    {{ staff.Name or (staff.FirstName ~ ' ' ~ staff.Surname) }}
                  </option>
                {% endfor %}
              </select>
            </div>
            <div class="form-text">Only required for Kaiako-led delivery.</div>
          </div>

        </div>
      </div>
    </div>
  {% endfor %}
</div>

{% else %}
<div class="d-flex justify-content-center">
  <div class="alert text-center w-40" style="background-color: #4d544120; color: #4d5441; border: 2px solid #4d5441;">
    No schools found for the selected term and year. Please contact your schools regarding uploading the relevant class lists.
  </div>
</div>
{% endif %}

<!-- ========================= -->
<!-- Add Provider Modal         -->
<!-- ========================= -->
<div class="modal fade" id="newProviderModal" tabindex="-1" aria-labelledby="newProviderModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="addProviderForm">
        <div class="modal-header">
          <h5 class="modal-title" id="newProviderModalLabel">Add New Provider</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="funder_id" value="{{ selected_funder }}">
          <div class="mb-3">
            <label for="providerName" class="form-label">Provider Name</label>
            <input type="text" class="form-control" id="providerName" name="provider_name" required>
          </div>
          <div id="addProviderSuccess" class="alert alert-success d-none"></div>
          <div id="addProviderError" class="alert alert-danger d-none"></div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Add Provider</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ========================= -->
<!-- JS                          -->
<!-- ========================= -->
<script>
document.addEventListener("DOMContentLoaded", () => {

  // ---------- helpers ----------
  const isKaiakoText = (txt) => (txt || "").toLowerCase().includes("kaiako");

  // NOTE: backend will be changed later to support Slot (1 = Provider1, 2 = Provider2)
  const postAssignProvider = async ({ moe, term, year, funderId, providerId, slot }) => {
    const response = await fetch("/assign_provider", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        MOENumber: moe,
        Term: term,
        Year: year,
        FunderID: funderId,
        ProviderID: providerId || null,
        Slot: slot
      })
    });
    const result = await response.json().catch(() => ({}));
    if (!response.ok || !result.success) {
      throw new Error(result.error || result.message || "assign_provider failed");
    }
    return result;
  };

  const postAssignKaiakoStaff = async ({ moe, term, year, email }) => {
    const response = await fetch("/assign_kaiako_staff", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        MOENumber: moe,
        Term: term,
        Year: year,
        Email: email || ""
      })
    });
    const result = await response.json().catch(() => ({}));
    if (!response.ok || !result.success) {
      throw new Error(result.message || "assign_kaiako_staff failed");
    }
    return result;
  };

  const fetchClmFacilities = async ({ funderId, term, year }) => {
    const url = `/api/clm_facilities?funder_id=${encodeURIComponent(funderId)}&term=${encodeURIComponent(term)}&year=${encodeURIComponent(year)}`;
    const response = await fetch(url);
    const result = await response.json().catch(() => ({}));
    if (!response.ok || !result.success) {
      throw new Error(result.message || "Failed to load CLM facilities");
    }
    return result.facilities || [];
  };

  const fetchClmFacilityStaff = async ({ facilityId }) => {
    const url = `/api/clm_facility_staff?facility_id=${encodeURIComponent(facilityId)}`;
    const response = await fetch(url);
    const result = await response.json().catch(() => ({}));
    if (!response.ok || !result.success) {
      throw new Error(result.message || "Failed to load facility staff");
    }
    return result.staff || [];
  };

  const populateSelectOptions = (selectEl, rows, { valueKey, labelKey, placeholderLabel }) => {
    if (!selectEl) return;
    const current = selectEl.value;

    selectEl.innerHTML = "";
    const ph = document.createElement("option");
    ph.value = "";
    ph.textContent = placeholderLabel;
    selectEl.appendChild(ph);

    rows.forEach(r => {
      const opt = document.createElement("option");
      opt.value = r[valueKey];
      opt.textContent = r[labelKey];
      selectEl.appendChild(opt);
    });

    // restore value if still present
    if (current) {
      const exists = Array.from(selectEl.options).some(o => String(o.value) === String(current));
      if (exists) selectEl.value = current;
    }
  };

  const loadFacilityStaffInto = async (scope) => {
    const clmFacilitySelect = scope.querySelector(".clm-facility-select");
    const clmStaffSelect    = scope.querySelector(".clm-staff-select");
    if (!clmFacilitySelect || !clmStaffSelect) return;

    const facilityId = clmFacilitySelect.value;
    if (!facilityId) {
      clmStaffSelect.innerHTML = `<option value="">Not Assigned</option>`;
      return;
    }

    try {
      const staff = await fetchClmFacilityStaff({ facilityId });
      const mapped = staff.map(s => {
        const name = s.Name || [s.FirstName, s.Surname].filter(Boolean).join(" ").trim();
        return { Email: s.Email, Name: name || (s.Email || "") };
      }).filter(x => x.Email);

      populateSelectOptions(clmStaffSelect, mapped, {
        valueKey: "Email",
        labelKey: "Name",
        placeholderLabel: "Not Assigned"
      });

    } catch (e) {
      console.error("❌ Facility staff load error:", e);
      clmStaffSelect.innerHTML = `<option value="">Not Assigned</option>`;
    }
  };

  // ---------- core UI state update per scope ----------
  const syncScopeUI = async (providerSelect) => {
    const scope = providerSelect.closest(".provider-scope");
    if (!scope) return;

    const isClm = scope.dataset.isClm === "1";
    const selectedText = providerSelect.options[providerSelect.selectedIndex]?.textContent || "";
    const isKaiako = isKaiakoText(selectedText);

    const nonClmStaffWrapper = scope.querySelector(".staff-dropdown-wrapper");
    const nonClmStaffSelect  = scope.querySelector(".funder-staff-select");

    const clmWrapper         = scope.querySelector(".clm-wrapper");
    const clmFacilitySelect  = scope.querySelector(".clm-facility-select");
    const clmStaffSelect     = scope.querySelector(".clm-staff-select");

    // Hide everything by default
    if (nonClmStaffWrapper) nonClmStaffWrapper.classList.add("d-none");
    if (clmWrapper) clmWrapper.classList.add("d-none");

    // If NOT kaiako, reset/hide staff & CLM controls
    if (!isKaiako) {
      if (nonClmStaffSelect) nonClmStaffSelect.selectedIndex = 0;

      if (clmFacilitySelect) clmFacilitySelect.value = "";
      if (clmStaffSelect) clmStaffSelect.innerHTML = `<option value="">Not Assigned</option>`;
      return;
    }

    // Kaiako selected:
    if (isClm) {
      // Show CLM facility+staff UI
      if (clmWrapper) clmWrapper.classList.remove("d-none");

      // Load facilities
      const funderId = providerSelect.dataset.funder;
      const term = providerSelect.dataset.term;
      const year = providerSelect.dataset.year;

      try {
        const facilities = await fetchClmFacilities({ funderId, term, year });
        const mapped = facilities.map(f => ({
          FacilityID: f.FacilityID ?? f.FacilityId ?? f.ProviderID ?? f.ID,
          FacilityName: f.FacilityName ?? f.Facility ?? f.Description ?? f.Name
        })).filter(x => x.FacilityID != null && x.FacilityName);

        populateSelectOptions(clmFacilitySelect, mapped, {
          valueKey: "FacilityID",
          labelKey: "FacilityName",
          placeholderLabel: "Not selected"
        });

        // Preselect current Provider2 (facility) if present
        const currentProvider2Id = scope.dataset.currentProvider2id;
        if (currentProvider2Id) {
          const has = Array.from(clmFacilitySelect.options).some(
            o => String(o.value) === String(currentProvider2Id)
          );
          if (has) {
            clmFacilitySelect.value = String(currentProvider2Id);
            await loadFacilityStaffInto(scope);
          }
        }
      } catch (e) {
        console.error("❌ CLM facilities load error:", e);
      }

    } else {
      // Non-CLM Kaiako: show funder staff dropdown
      if (nonClmStaffWrapper) nonClmStaffWrapper.classList.remove("d-none");
    }
  };

  // ---------- Provider dropdown handlers ----------
  document.querySelectorAll(".provider-select").forEach(select => {
    let previousText = select.options[select.selectedIndex]?.textContent?.toLowerCase() || "";

    // Initial UI
    syncScopeUI(select);

    select.addEventListener("change", async () => {
      const selectedText = select.options[select.selectedIndex]?.textContent?.toLowerCase() || "";

      const scope = select.closest(".provider-scope");
      const moe  = select.dataset.moe;
      const term = select.dataset.term;
      const year = select.dataset.year;
      const funderId = select.dataset.funder;

      // If user changed from Kaiako to non-Kaiako, delete staff assignment + clear facility UI
      if (previousText.includes("kaiako") && !selectedText.includes("kaiako")) {
        try {
          await postAssignKaiakoStaff({ moe, term, year, email: "" });
        } catch (err) {
          console.error("❌ Error deleting staff assignment:", err);
        }

        if (scope) {
          const facilitySelect = scope.querySelector(".clm-facility-select");
          const staffSelect = scope.querySelector(".clm-staff-select");
          if (facilitySelect) facilitySelect.value = "";
          if (staffSelect) staffSelect.innerHTML = `<option value="">Not Assigned</option>`;
          scope.dataset.currentProvider2id = "";
        }
      }

      // Assign Provider1 (slot 1)
      try {
        await postAssignProvider({
          moe, term, year, funderId,
          providerId: select.value || null,
          slot: 1
        });
        if (scope) scope.dataset.currentProvider1id = select.value || "";
      } catch (err) {
        console.error("❌ Error assigning Provider1:", err);
      }

      previousText = selectedText;
      await syncScopeUI(select);
    });
  });

  // ---------- NON-CLM funder staff dropdown handler ----------
  document.querySelectorAll(".funder-staff-select").forEach(dropdown => {
    dropdown.addEventListener("change", async () => {
      const selectedEmail = dropdown.value;
      const moe  = dropdown.dataset.moe;
      const term = dropdown.dataset.term;
      const year = dropdown.dataset.year;

      try {
        await postAssignKaiakoStaff({ moe, term, year, email: selectedEmail });
      } catch (err) {
        console.error("❌ Error posting to /assign_kaiako_staff:", err);
      }
    });
  });

  // ---------- CLM facility dropdown: assigns Provider2 + loads staff ----------
  document.querySelectorAll(".clm-facility-select").forEach(select => {
    select.addEventListener("change", async () => {
      const scope = select.closest(".provider-scope");
      if (!scope) return;

      const facilityProviderId = select.value;
      const moe  = select.dataset.moe;
      const term = select.dataset.term;
      const year = select.dataset.year;
      const funderId = select.dataset.funder;

      // Assign Provider2 (slot 2)
      try {
        await postAssignProvider({
          moe, term, year, funderId,
          providerId: facilityProviderId || null,
          slot: 2
        });
        scope.dataset.currentProvider2id = facilityProviderId || "";
      } catch (err) {
        console.error("❌ Error assigning Provider2 (facility):", err);
      }

      await loadFacilityStaffInto(scope);
    });
  });

  // ---------- CLM facility staff dropdown: triggers assign_kaiako_staff ----------
  document.querySelectorAll(".clm-staff-select").forEach(dropdown => {
    dropdown.addEventListener("change", async () => {
      const selectedEmail = dropdown.value;
      const moe  = dropdown.dataset.moe;
      const term = dropdown.dataset.term;
      const year = dropdown.dataset.year;

      try {
        await postAssignKaiakoStaff({ moe, term, year, email: selectedEmail });
      } catch (err) {
        console.error("❌ Error assigning CLM facility staff:", err);
      }
    });
  });

  // ---------- Add Provider modal form ----------
  const addProviderForm = document.getElementById("addProviderForm");
  if (addProviderForm) {
    addProviderForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const form = e.target;

      const providerName = form.provider_name.value;
      const funderId     = form.funder_id.value;

      const successAlert = document.getElementById("addProviderSuccess");
      const errorAlert   = document.getElementById("addProviderError");

      successAlert.classList.add("d-none");
      errorAlert.classList.add("d-none");

      try {
        const response = await fetch("/add_provider", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ provider_name: providerName, funder_id: funderId })
        });

        const result = await response.json().catch(() => ({}));

        if (response.ok && result.success) {
          successAlert.textContent = "✅ Provider added successfully.";
          successAlert.classList.remove("d-none");
          form.reset();
          setTimeout(() => location.reload(), 800);
        } else {
          errorAlert.textContent = result.message || "❌ Failed to add provider.";
          errorAlert.classList.remove("d-none");
        }
      } catch (err) {
        console.error("❌ Error adding provider:", err);
        errorAlert.textContent = "❌ Something went wrong.";
        errorAlert.classList.remove("d-none");
      }
    });
  }

});
</script>

{% endblock %}
