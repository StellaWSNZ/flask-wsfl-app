{% extends "header.html" %} {% block title %}Classes{% endblock %} {% block
content %}
<style>
  @font-face {
    font-family: "PP Mori";
    src: url("/static/fonts/ppmori-regular-webfont.woff2") format("woff2");
    font-weight: 400;
    font-style: normal;
  }
  @font-face {
    font-family: "PP Mori";
    src: url("/static/fonts/ppmori-semibold-webfont.woff2") format("woff2");
    font-weight: 700;
    font-style: normal;
  }

  :root {
    --bs-primary: #1a427d;
    --bs-primary-rgb: 26, 66, 125;
    --bs-secondary: #4d5441;
  }

  body {
    font-family: "PP Mori", "Segoe UI", sans-serif;
  }

  .modal-header-primary {
    background-color: var(--bs-primary) !important;
    color: #fff !important;
    border-bottom: none !important;
  }
  .modal-header-primary .btn-close {
    filter: invert(1);
  }

  .modal-header-danger {
    background-color: var(--bs-danger) !important;
    color: #fff !important;
    border-bottom: none !important;
  }
  .modal-header-danger .btn-close {
    filter: invert(1);
  }

  .btn-outline-danger-custom {
    border-color: #dc3545;
    color: #dc3545;
  }
  .btn-outline-danger-custom:hover {
    background: #dc3545;
    color: #fff;
  }

  .btn-info-custom {
    background: #0dcaf0;
    border-color: #0dcaf0;
    color: #000;
  }
  .btn-info-custom:hover {
    filter: brightness(0.95);
  }
</style>

<h3 class="text-primary mb-4 text-center">Filter Classes</h3>

<form method="POST" id="filter-form">
  <div class="container">
    <div class="row justify-content-center align-items-end g-3">
      <!-- Term -->
      <div class="col-md-2">
        <label for="term" class="form-label">Term</label>
        <select name="term" id="term" class="form-select" required>
          <!-- prettier-ignore -->
          <option value="" disabled {% if not selected_term %}selected{% endif %}>Select term</option>

          {% for t in terms %} {% set t_val = t.Term if t.Term is defined else
          (t.term if t.term is defined else t) %}
          <!-- prettier-ignore -->
          <option value="{{ t_val }}" {% if selected_term|string == t_val|string %}selected{% endif %}>{{ t_val }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Year -->
      <div class="col-md-2">
        <label for="calendaryear" class="form-label">Year</label>
        <select
          name="calendaryear"
          id="calendaryear"
          class="form-select"
          required
        >
          <!-- prettier-ignore -->
          <option value="" disabled {% if not selected_year %}selected{% endif %}>Select year</option>

          {% for y in years %} {% set y_val = y.CalendarYear if y.CalendarYear
          is defined else (y.year if y.year is defined else y) %}
          <!-- prettier-ignore -->
          <option value="{{ y_val }}" {% if selected_year|string == y_val|string %}selected{% endif %}>{{ y_val }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- School (hidden for MOE users) -->
      {% if user_role != "MOE" %}
      <div class="col-md-4" id="school-wrapper" style="display: none">
        <label for="moe_number" class="form-label">School</label>
        <select name="moe_number" id="moe_number" class="form-select" required>
          <option value="">Select School</option>
        </select>
      </div>

      <div class="col-md-auto" id="find-btn-wrapper" style="display: none">
        <button type="submit" class="btn btn-primary w-100">
          Find Classes
        </button>
      </div>
      {% else %}
      <div class="col-md-4" id="school-wrapper" style="display: block">
        <label class="form-label">School</label>
        <input class="form-control" value="{{ desc or '' }}" readonly />
      </div>

      <div class="col-md-auto" id="find-btn-wrapper" style="display: block">
        <button type="submit" class="btn btn-primary w-100">
          Find Classes
        </button>
      </div>
      {% endif %}
    </div>
  </div>
</form>

<!-- Classes -->
{% if classes %}
<div class="container mt-4">
  <h4 class="text-center mb-3">Select a Class</h4>

  <!-- Desktop table -->
  <div class="d-none d-sm-block">
    <div class="row justify-content-center">
      <div class="col-md-10">
        <table class="table table-sm table-borderless">
          <tbody>
            {% for cls in classes %}
            <tr class="align-middle">
              <td><strong>Class Name:</strong> {{ cls.ClassName }}</td>
              <td><strong>Teacher Name:</strong> {{ cls.TeacherName }}</td>
              <td><strong>Year Levels:</strong> {{ cls.YearLevels }}</td>

              <td>
                <a
                  class="btn btn-sm btn-outline-primary"
                  href="{{ url_for('class_bp.view_class', moe_number=moe_number, class_id=cls.ClassID, term=selected_term, year=selected_year, filter='all') }}"
                >
                  View All Competencies
                </a>
              </td>

              <td>
                <a
                  class="btn btn-sm btn-outline-secondary"
                  href="{{ url_for('class_bp.view_class', moe_number=moe_number, class_id=cls.ClassID, term=selected_term, year=selected_year, filter='water') }}"
                >
                  View Water-Based Competencies
                </a>
              </td>

              <td>
                {% if user_admin == 1 and cls.Movable == 1 %}
                <div
                  class="btn-group btn-group-sm"
                  role="group"
                  aria-label="Move class"
                >
                  <button
                    type="button"
                    class="btn btn-outline-info move-class-btn"
                    title="Move Class"
                    data-class-id="{{ cls.ClassID }}"
                    data-class-name="{{ cls.ClassName }}"
                    data-teacher-name="{{ cls.TeacherName }}"
                    data-current-term="{{ selected_term }}"
                    data-current-year="{{ selected_year }}"
                  >
                    Move Class
                  </button>
                </div>
                {% endif %}
              </td>

              <td>
                {% if user_admin == 1 and cls.Movable == 1 %}
                <div
                  class="btn-group btn-group-sm"
                  role="group"
                  aria-label="Delete class"
                >
                  <button
                    type="button"
                    class="btn btn-outline-danger-custom delete-class-btn"
                    title="Delete Class"
                    data-class-id="{{ cls.ClassID }}"
                    data-class-name="{{ cls.ClassName }}"
                    data-teacher-name="{{ cls.TeacherName }}"
                    data-current-term="{{ selected_term }}"
                    data-current-year="{{ selected_year }}"
                  >
                    Delete Class
                  </button>
                </div>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Mobile cards -->
  <div class="d-sm-none" id="classCards">
    {% for cls in classes %}
    <div class="card shadow-sm mb-3 border-0">
      <div class="card-body">
        <h6 class="card-title mb-2 text-primary fw-semibold">
          {{ cls.ClassName }}
        </h6>
        <p class="mb-1">
          <span class="fw-semibold text-muted">Teacher:</span> {{
          cls.TeacherName }}
        </p>
        <p class="mb-3">
          <span class="fw-semibold text-muted">Year Levels:</span> {{
          cls.YearLevels }}
        </p>

        <div class="d-flex flex-wrap gap-2 mt-2">
          <a
            class="btn btn-outline-secondary btn-sm"
            href="{{ url_for('class_bp.view_class', moe_number=moe_number, class_id=cls.ClassID, term=selected_term, year=selected_year, filter='all') }}"
          >
            All Competencies
          </a>

          <a
            class="btn btn-outline-primary btn-sm"
            href="{{ url_for('class_bp.view_class', moe_number=moe_number, class_id=cls.ClassID, term=selected_term, year=selected_year, filter='water') }}"
          >
            Water-Based
          </a>

          {% if user_admin == 1 and cls.Movable == 1 %}
          <button
            type="button"
            class="btn btn-outline-info btn-sm move-class-btn"
            title="Move Class"
            data-class-id="{{ cls.ClassID }}"
            data-class-name="{{ cls.ClassName }}"
            data-teacher-name="{{ cls.TeacherName }}"
            data-current-term="{{ selected_term }}"
            data-current-year="{{ selected_year }}"
          >
            Move
          </button>

          <button
            type="button"
            class="btn btn-outline-danger btn-sm delete-class-btn"
            title="Delete Class"
            data-class-id="{{ cls.ClassID }}"
            data-class-name="{{ cls.ClassName }}"
            data-teacher-name="{{ cls.TeacherName }}"
            data-current-term="{{ selected_term }}"
            data-current-year="{{ selected_year }}"
          >
            Delete
          </button>
          {% endif %}
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>
{% endif %}

<!-- Suggestions -->
{% if suggestions and not classes %}
<div class="container mt-4">
  <div class="row justify-content-center">
    <div class="col-md-6">
      <div class="alert alert-warning text-center">
        <strong
          >No classes with students and year levels found for this term.</strong
        ><br />
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- Move Class Modal -->
<div
  class="modal fade"
  id="moveClassModal"
  tabindex="-1"
  aria-labelledby="moveClassLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header modal-header-primary">
        <h5 class="modal-title" id="moveClassLabel">Moving Class</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>

      <div class="modal-body">
        <p class="mb-2">
          You can move this class to another term and calendar year.
        </p>
        <p id="move-class-description" class="fw-semibold mb-3"></p>

        <form id="move-class-form">
          <input type="hidden" id="move-class-id" />
          <input type="hidden" id="move-original-term" />
          <input type="hidden" id="move-original-year" />

          <div class="mb-3">
            <label for="move-term" class="form-label">New Term</label>
            <select id="move-term" class="form-select" required>
              {% for t in terms %} {% set t_val = t.Term if t.Term is defined
              else (t.term if t.term is defined else t) %}
              <!-- prettier-ignore -->
              <option value="{{ t_val }}">{{ t_val }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="mb-3">
            <label for="move-year" class="form-label">New Calendar Year</label>
            <select id="move-year" class="form-select" required>
              {% for y in years %} {% set y_val = y.CalendarYear if
              y.CalendarYear is defined else (y.year if y.year is defined else
              y) %}
              <!-- prettier-ignore -->
              <option value="{{ y_val }}">{{ y_val }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="small text-muted">
            The class will be moved for this school only. Students and
            achievements stay attached to the class.
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-outline-secondary"
          data-bs-dismiss="modal"
        >
          Cancel
        </button>
        <button
          type="button"
          class="btn btn-info-custom"
          id="confirm-move-btn"
          disabled
        >
          Move Class
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Class Modal -->
<div
  class="modal fade"
  id="deleteClassModal"
  tabindex="-1"
  aria-labelledby="deleteClassLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header modal-header-danger">
        <h5 class="modal-title" id="deleteClassLabel">Delete Class</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>

      <div class="modal-body">
        <p class="mb-2">Are you sure you want to delete this class?</p>
        <p id="delete-class-description" class="fw-semibold mb-3"></p>
        <p class="small text-muted">
          This action cannot be undone. Students and mappings associated only
          with this class may be removed.
        </p>

        <input type="hidden" id="delete-class-id" />
        <input type="hidden" id="delete-term" />
        <input type="hidden" id="delete-year" />
      </div>

      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-outline-secondary"
          data-bs-dismiss="modal"
        >
          Cancel
        </button>
        <button type="button" class="btn btn-danger" id="confirm-delete-btn">
          Delete Class
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %} {% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", () => {
    // Move modal
    const moveModalEl = document.getElementById("moveClassModal");
    const moveModal = moveModalEl ? new bootstrap.Modal(moveModalEl) : null;
    const moveDescEl = document.getElementById("move-class-description");
    const moveClassId = document.getElementById("move-class-id");
    const moveOrigTerm = document.getElementById("move-original-term");
    const moveOrigYear = document.getElementById("move-original-year");
    const moveTermSel = document.getElementById("move-term");
    const moveYearSel = document.getElementById("move-year");
    const moveConfirm = document.getElementById("confirm-move-btn");

    // Delete modal
    const deleteModalEl = document.getElementById("deleteClassModal");
    const deleteModal = deleteModalEl
      ? new bootstrap.Modal(deleteModalEl)
      : null;
    const deleteDescEl = document.getElementById("delete-class-description");
    const deleteClassId = document.getElementById("delete-class-id");
    const deleteTerm = document.getElementById("delete-term");
    const deleteYear = document.getElementById("delete-year");
    const deleteConfirm = document.getElementById("confirm-delete-btn");

    const filterForm = document.getElementById("filter-form");

    // --- Move modal logic ---
    if (moveModal) {
      function updateMoveButtonState() {
        const origTerm = moveOrigTerm.value;
        const origYear = moveOrigYear.value;
        const newTerm = moveTermSel.value;
        const newYear = moveYearSel.value;
        moveConfirm.disabled = !(
          newTerm &&
          newYear &&
          (newTerm !== origTerm || newYear !== origYear)
        );
      }

      document.querySelectorAll(".move-class-btn").forEach((btn) => {
        btn.addEventListener("click", (e) => {
          e.preventDefault();

          moveClassId.value = btn.dataset.classId || "";
          moveOrigTerm.value = btn.dataset.currentTerm || "";
          moveOrigYear.value = btn.dataset.currentYear || "";

          const className = btn.dataset.className || "";
          const teacherName = btn.dataset.teacherName || "";

          if (moveDescEl) {
            moveDescEl.textContent = `This class: ${className} (Teacher: ${teacherName}), currently in Term ${moveOrigTerm.value}, ${moveOrigYear.value}.`;
          }

          if (moveTermSel) moveTermSel.value = moveOrigTerm.value;
          if (moveYearSel) moveYearSel.value = moveOrigYear.value;

          updateMoveButtonState();
          moveModal.show();
        });
      });

      moveTermSel?.addEventListener("change", updateMoveButtonState);
      moveYearSel?.addEventListener("change", updateMoveButtonState);

      moveConfirm?.addEventListener("click", async () => {
        const classId = moveClassId.value;
        const newTerm = moveTermSel.value;
        const newYear = moveYearSel.value;
        if (!classId || !newTerm || !newYear) return;

        try {
          const res = await fetch("{{ url_for('class_bp.move_class') }}", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Requested-With": "XMLHttpRequest",
            },
            credentials: "same-origin",
            body: JSON.stringify({
              class_id: classId,
              term: newTerm,
              year: newYear,
            }),
          });

          const ct = res.headers.get("Content-Type") || "";
          if (!res.ok || !ct.includes("application/json"))
            throw new Error("Bad response");

          const data = await res.json();
          if (data?.ok) filterForm?.submit();
          else alert(data?.error || "There was a problem moving this class.");
        } catch (err) {
          console.error("Move class failed:", err);
          alert("There was a problem moving this class. Please try again.");
        } finally {
          moveModal.hide();
        }
      });
    }

    // --- Delete modal logic ---
    if (deleteModal) {
      document.querySelectorAll(".delete-class-btn").forEach((btn) => {
        btn.addEventListener("click", (e) => {
          e.preventDefault();

          const className = btn.dataset.className || "";
          const teacherName = btn.dataset.teacherName || "";
          const currentTerm = btn.dataset.currentTerm || "";
          const currentYear = btn.dataset.currentYear || "";

          deleteClassId.value = btn.dataset.classId || "";
          if (deleteTerm) deleteTerm.value = currentTerm;
          if (deleteYear) deleteYear.value = currentYear;

          if (deleteDescEl) {
            deleteDescEl.textContent = `This class: ${className} (Teacher: ${teacherName}), Term ${currentTerm}, ${currentYear}.`;
          }

          deleteModal.show();
        });
      });

      deleteConfirm?.addEventListener("click", async () => {
        const classId = deleteClassId.value;
        const term = deleteTerm?.value;
        const year = deleteYear?.value;
        if (!classId || !term || !year) return;

        try {
          const res = await fetch("{{ url_for('class_bp.delete_class') }}", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Requested-With": "XMLHttpRequest",
            },
            credentials: "same-origin",
            body: JSON.stringify({ class_id: classId, term: term, year: year }),
          });

          const ct = res.headers.get("Content-Type") || "";
          if (!res.ok || !ct.includes("application/json"))
            throw new Error("Bad response");

          const data = await res.json();
          if (data?.ok) filterForm?.submit();
          else alert(data?.error || "There was a problem deleting this class.");
        } catch (err) {
          console.error("Delete class failed:", err);
          alert("There was a problem deleting this class. Please try again.");
        } finally {
          deleteModal.hide();
        }
      });
    }
  });

  // -------------------------
  // School fetching logic (AJAX)
  // -------------------------
  function endpointForRole(role, term, year) {
    role = (role || "").toUpperCase();
    if (!term || !year) return "";

    if (role === "PRO")
      return `/get_schools_by_provider?term=${term}&year=${year}`;
    if (role === "FUN")
      return `/get_schools_by_funder?term=${term}&year=${year}`;
    if (role === "ADM")
      return `/get_schools_for_term_year?term=${term}&year=${year}`;
    if (role === "GRP")
      return `/get_schools_by_group?term=${term}&year=${year}`;
    return "";
  }

  async function fetchSchools() {
    const role = "{{ user_role or '' }}";
    if ((role || "").toUpperCase() === "MOE") return;

    const termEl = document.getElementById("term");
    const yearEl = document.getElementById("calendaryear");
    const schoolWrapper = document.getElementById("school-wrapper");
    const schoolSelect = document.getElementById("moe_number");
    const findBtn = document.getElementById("find-btn-wrapper");

    const term = termEl?.value;
    const year = yearEl?.value;

    if (!term || !year) {
      schoolWrapper.style.display = "none";
      findBtn.style.display = "none";
      return;
    }

    const url = endpointForRole(role, term, year);
    if (!url) return;

    const currentMoe =
      "{{ (request.form.get('moe_number') or moe_number or '') }}";

    schoolWrapper.style.display = "block";
    findBtn.style.display = "none";
    schoolSelect.disabled = true;
    schoolSelect.innerHTML = '<option value="">Loadingâ€¦</option>';

    try {
      const res = await fetch(url, {
        cache: "no-store",
        credentials: "same-origin",
      });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();

      schoolSelect.innerHTML = '<option value="">Select School</option>';

      for (const s of data || []) {
        const opt = document.createElement("option");
        opt.value = s.MOENumber;
        opt.textContent = s.School || s.SchoolName || `${s.MOENumber}`;
        schoolSelect.appendChild(opt);
      }

      if (currentMoe) schoolSelect.value = currentMoe;

      schoolSelect.disabled = false;
      findBtn.style.display = "block";
    } catch (e) {
      console.error("Failed to load schools:", e);
      schoolSelect.innerHTML =
        '<option value="">Failed to load schools</option>';
      schoolSelect.disabled = true;
      findBtn.style.display = "none";
    }
  }

  window.addEventListener("DOMContentLoaded", () => {
    const role = "{{ user_role or '' }}".toUpperCase();

    if (role !== "MOE") {
      const termVal = "{{ selected_term or '' }}";
      const yearVal = "{{ selected_year or '' }}";

      const termEl = document.getElementById("term");
      const yearEl = document.getElementById("calendaryear");

      if (termEl && termVal && !termEl.value) termEl.value = termVal;
      if (yearEl && yearVal && !yearEl.value) yearEl.value = yearVal;

      fetchSchools();

      document.getElementById("term")?.addEventListener("change", fetchSchools);
      document
        .getElementById("calendaryear")
        ?.addEventListener("change", fetchSchools);
    }
  });
</script>
{% endblock %}
