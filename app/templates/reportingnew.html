{% extends "header.html" %}
{% block title %}New Reporting{% endblock %}

{% block content %}
<div class="container-fluid mt-4" style="max-width:98%;">
  <div class="row">
    <!-- ===== Sidebar (controls) ===== -->
    <div class="col-lg-3 mb-4">
      <div class="card sticky-top" style="top:1rem;">
        <div class="card-header text-white" style="background:#1a427d;">
          Configure Report
        </div>
        <div class="card-body">
          <form method="POST" id="report-form" action="{{ url_for('report_bp.new_reports') }}" novalidate>
            {% if csrf_token is defined %}
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            {% endif %}

            <!-- Year -->
            <div class="mb-3">
              <label for="year" class="form-label">Year</label>
              <select name="year" id="year" class="form-select">
                <option value="2025" {% if selected_year == 2025 or not selected_year %}selected{% endif %}>2025</option>
              </select>
            </div>

            <!-- Term -->
            <div class="mb-3">
              <label for="term" class="form-label">Term</label>
              <select name="term" id="term" class="form-select">
                <option value="3" {% if selected_term == 3 or not selected_term %}selected{% endif %}>3</option>
              </select>
            </div>

            <!-- Report Type -->
            <div class="mb-3">
              <label for="report_option" class="form-label">Report Type</label>
              <select name="report_option" id="report_option" class="form-select">
                {% if role in ["ADM","FUN"] %}
                  <option value="funder_ytd_vs_target"
                    {% if selected_type == "funder_ytd_vs_target" or not selected_type %}selected{% endif %}>
                    YTD Funder Performance vs WSNZ Target
                  </option>
                  <option value="ly_funder_vs_ly_national_vs_target"
                    {% if selected_type == "ly_funder_vs_ly_national_vs_target" %}selected{% endif %}>
                    LY Funder Performance vs LY National vs WSNZ Target
                  </option>
                  <option value="provider_ytd_vs_target"
                    {% if selected_type == "provider_ytd_vs_target" %}selected{% endif %}>
                    Provider YTD Performance vs WSNZ Target
                  </option>
                  <option value="provider_ytd_vs_target_vs_funder"
                    {% if selected_type == "provider_ytd_vs_target_vs_funder" %}selected{% endif %}>
                    Provider YTD vs Funder YTD vs Target
                  </option>
                  <option value="school_ytd_vs_national"
                    {% if selected_type == "school_ytd_vs_national" %}selected{% endif %}>
                    School YTD Performance vs WSNZ Target
                  </option>
                {% elif role == "PRO" %}
                  <option value="provider_ytd_vs_target"
                    {% if selected_type == "provider_ytd_vs_target" or not selected_type %}selected{% endif %}>
                    YTD Performance vs WSNZ Target
                  </option>
                  <option value="school_ytd_vs_national"
                    {% if selected_type == "school_ytd_vs_national" %}selected{% endif %}>
                    School YTD Performance vs WSNZ Target
                  </option>
                {% elif role == "GRP" %}
                  <option value="provider_ytd_vs_target"
                    {% if selected_type == "provider_ytd_vs_target" or not selected_type %}selected{% endif %}>
                    Provider YTD Performance vs WSNZ Target
                  </option>
                  <option value="school_ytd_vs_national"
                    {% if selected_type == "school_ytd_vs_national" %}selected{% endif %}>
                    School YTD Performance vs WSNZ Target
                  </option>
                {% elif role == "MOE" %}
                  <option value="school_ytd_vs_national"
                    {% if selected_type == "school_ytd_vs_national" or not selected_type %}selected{% endif %}>
                    YTD Performance vs WSNZ Target
                  </option>
                {% endif %}
              </select>
            </div>

            <!-- Funder (appears only when report type needs it) -->
            <div class="mb-3" id="funderBlock" style="display:none;">
              {% if role == "ADM" %}
                <label for="selected_funder" class="form-label">Funder</label>
                <select name="selected_funder" id="selected_funder" class="form-select">
                  <option value="" disabled selected>Loading funders…</option>
                </select>
              {% elif role == "FUN" and funder_name %}
                <label class="form-label">Funder</label>
                <input class="form-control" value="{{ funder_name }}" readonly>
              {% endif %}
            </div>

            <!-- Provider (only for provider reports) -->
            <div class="mb-3" id="providerBlock" style="display:none;">
              <label for="provider_id" class="form-label">Provider</label>
              <select name="provider_id" id="provider_id" class="form-select">
                <option value="" disabled selected>Choose provider…</option>
              </select>
            </div>

            <!-- School (MOE number) -->
            <div class="mb-3" id="schoolBlock" style="display:none;">
              <label for="school_id" class="form-label">School</label>
              <select name="school_id" id="school_id" class="form-select">
                <option value="" disabled selected>Choose school…</option>
              </select>
            </div>

            <!-- Hidden: provider/school names for titles -->
            <input type="hidden" name="provider_name" id="provider_name" value="">
            <input type="hidden" name="school_name" id="school_name" value="">

            <div class="d-grid">
              <button type="submit" name="action" value="show_report" class="btn btn-primary">Show report</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- ===== Main content ===== -->
    <div class="col-lg-9">
      <div class="card">
        <div id="report-header" class="card-header text-white d-flex justify-content-between align-items-start" style="background:#1a427d;">
          <div id="report-header-left">
            {% if funder_name %}{{ funder_name }} • {% endif %}
            {% if selected_term and selected_year %}
              Term {{ selected_term }}, {{ selected_year }}
            {% else %}
              Select options and run report
            {% endif %}
            {% set provider_name = request.form.get('provider_name') %}
            {% set school_name = request.form.get('school_name') %}
            {% if provider_name %} • {{ provider_name }}{% endif %}
            {% if school_name %} • {{ school_name }}{% endif %}
          </div>
          <!-- (No buttons in the header) -->
        </div>

        <div class="card-body">
          <div id="chart-container"
               class="position-relative text-center"
               style="min-height:220px; max-height:85vh; overflow:visible;">

            <!-- Message placeholder -->
            <div id="chart-message" style="color:#1a427d; font-weight:600;">
              {% if plot_png_b64 %}
                <span style="display:none;">Report will appear here once submitted.</span>
              {% else %}
                Report will appear here once submitted.
              {% endif %}
            </div>

            <!-- Chart image (no Jinja inside style=) -->
            <img id="report-img"
                 class="img-fluid mx-auto fade-in {{ 'is-visible d-block' if plot_png_b64 else 'd-none' }}"
                 src="{{ ('data:image/png;base64,' ~ plot_png_b64) if plot_png_b64 else '' }}"
                 alt="Report chart"
                 style="max-width:100%; height:auto; max-height:70vh; object-fit:contain; border:1px solid #eee; border-radius:.5rem;" />

            <!-- Export buttons UNDER the image; toggle with classes instead of inline styles -->
            <div id="exportButtons"
                 class="justify-content-center gap-2 mt-3 {{ 'd-flex' if display else 'd-none' }}">
              <a class="btn btn-sm btn-outline-primary" href="{{ url_for('report_bp.download_pdf') }}">Export PDF</a>
              <a class="btn btn-sm btn-outline-primary" href="{{ url_for('report_bp.download_png') }}">Export PNG</a>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .fade-in { opacity:0; transition:opacity .25s ease; }
  .fade-in.is-visible { opacity:1; }
</style>

<script>
/* ===================== Controls & data-loading ===================== */
(function () {
  const ENTITIES_URL   = "{{ entities_url }}";
  const ROLE           = "{{ role }}";
  const FUNDER_NAME    = "{{ funder_name or '' }}";

  const form              = document.getElementById('report-form');
  const reportSel         = document.getElementById('report_option');

  const funderBlock       = document.getElementById('funderBlock');
  const funderSel         = document.getElementById('selected_funder'); // ADM only

  const providerBlock     = document.getElementById('providerBlock');
  const providerSel       = document.getElementById('provider_id');
  const providerNameInput = document.getElementById('provider_name');

  const schoolBlock       = document.getElementById('schoolBlock');
  const schoolSel         = document.getElementById('school_id');
  const schoolNameInput   = document.getElementById('school_name');

  const prevProviderId = "{{ request.form.get('provider_id', '') }}";
  const prevFunderName = "{{ request.form.get('selected_funder', funder_name or '') }}";
  const prevSchoolId   = "{{ request.form.get('school_id', '') }}";

  // prevent accidental submit with Enter
  form.addEventListener('keydown', (e) => { if (e.key === 'Enter') e.preventDefault(); });

  function needsProvider(val) {
    return ['provider_ytd_vs_target', 'provider_ytd_vs_target_vs_funder'].includes(val);
  }
  function needsSchool(val) {
    return ['school_ytd_vs_national', 'school_ytd_vs_target'].includes(val);
  }
  function needsFunder(val) {
    return [
      'funder_ytd_vs_target',
      'ly_funder_vs_ly_national_vs_target',
      'provider_ytd_vs_target_vs_funder'
    ].includes(val);
  }

  async function loadFunders() {
    if (!funderSel) return;
    funderSel.innerHTML = '<option value="" disabled>Loading funders…</option>';
    try {
      const res = await fetch(ENTITIES_URL + '?entity_type=Funder', { credentials: 'same-origin' });
      const items = await res.json();
      funderSel.innerHTML = '<option value="" disabled>Choose funder…</option>';
      for (const f of items) {
        const opt = document.createElement('option');
        opt.value = f.name;
        opt.textContent = f.name;
        if (prevFunderName && f.name === prevFunderName) opt.selected = true;
        funderSel.appendChild(opt);
      }
      if (!funderSel.value) funderSel.querySelector('option[disabled]')?.setAttribute('selected', 'selected');
    } catch {
      funderSel.innerHTML = '<option value="" disabled>Error loading funders</option>';
    }
  }

  async function loadProviders() {
    providerSel.innerHTML = '<option value="" disabled>Loading providers…</option>';
    try {
      const funderName = (funderSel && funderSel.value) ? funderSel.value : FUNDER_NAME;
      const qs = new URLSearchParams({ entity_type: 'Provider' });
      if (funderName) qs.set('funder_name', funderName);

      const res = await fetch(ENTITIES_URL + '?' + qs.toString(), { credentials: 'same-origin' });
      const items = await res.json();

      providerSel.innerHTML = '<option value="" disabled>Choose provider…</option>';
      let picked = false;
      for (const p of items) {
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = p.name;
        if (prevProviderId && String(p.id) === String(prevProviderId)) { opt.selected = true; picked = true; }
        providerSel.appendChild(opt);
      }
      if (!providerSel.value) providerSel.querySelector('option[disabled]')?.setAttribute('selected', 'selected');

      const txt = providerSel.options[providerSel.selectedIndex]?.textContent || '';
      providerNameInput.value = picked ? txt : '';
    } catch {
      providerSel.innerHTML = '<option value="" disabled>Error loading providers</option>';
      providerNameInput.value = '';
    }
  }

  async function loadSchools() {
    schoolSel.innerHTML = '<option value="" disabled>Loading schools…</option>';
    try {
      const qs = new URLSearchParams({ entity_type: 'School' });
      const res = await fetch(ENTITIES_URL + '?' + qs.toString(), { credentials: 'same-origin' });
      const items = await res.json();

      schoolSel.innerHTML = '<option value="" disabled>Choose school…</option>';
      let picked = false;
      for (const s of items) {
        const opt = document.createElement('option');
        opt.value = s.id;
        opt.textContent = s.name;
        if (prevSchoolId && String(s.id) === String(prevSchoolId)) { opt.selected = true; picked = true; }
        schoolSel.appendChild(opt);
      }
      if (!schoolSel.value) schoolSel.querySelector('option[disabled]')?.setAttribute('selected', 'selected');

      const txt = schoolSel.options[schoolSel.selectedIndex]?.textContent || '';
      schoolNameInput.value = picked ? txt : '';
    } catch {
      schoolSel.innerHTML = '<option value="" disabled>Error loading schools</option>';
      schoolNameInput.value = '';
    }
  }

  async function toggleEntityBlocks() {
    const val = reportSel.value;

    // Funder
    const wantFunder = needsFunder(val);
    if (funderBlock) {
      funderBlock.style.display = wantFunder ? 'block' : 'none';
      if (wantFunder && "{{ role }}" === 'ADM') {
        loadFunders();
      } else if (!wantFunder && "{{ role }}" === 'ADM' && funderSel) {
        funderSel.selectedIndex = 0; // optional clear
      }
    }

    // Provider
    const wantProvider = needsProvider(val);
    providerBlock.style.display = wantProvider ? 'block' : 'none';
    if (wantProvider) loadProviders();
    else {
      providerSel.innerHTML = '<option value="" disabled>Choose provider…</option>';
      providerNameInput.value = '';
    }

    // School
    const wantSchool = needsSchool(val);
    schoolBlock.style.display = wantSchool ? 'block' : 'none';
    if (wantSchool) loadSchools();
    else {
      schoolSel.innerHTML = '<option value="" disabled>Choose school…</option>';
      schoolNameInput.value = '';
    }
  }

  providerSel?.addEventListener('change', () => {
    const txt = providerSel.options[providerSel.selectedIndex]?.textContent || '';
    providerNameInput.value = txt;
  });
  schoolSel?.addEventListener('change', () => {
    const txt = schoolSel.options[schoolSel.selectedIndex]?.textContent || '';
    schoolNameInput.value = txt;
  });

  reportSel.addEventListener('change', toggleEntityBlocks);

  // Initial state
  toggleEntityBlocks();
})();
</script>

<script>
/* ===================== AJAX submit + show/hide export via 'display' ===================== */
(function () {
  const form      = document.getElementById('report-form');
  const reportImg = document.getElementById('report-img');
  const msg       = document.getElementById('chart-message');
  const btns      = document.getElementById('exportButtons');

  form.addEventListener('submit', async function (e) {
    const submitter = e.submitter;
    const actionVal = submitter?.value || new FormData(form).get('action');
    if (actionVal !== 'show_report') return;

    e.preventDefault();

    // Loading state
    if (msg) { msg.textContent = 'Loading report, please wait…'; msg.style.display = 'block'; }
    if (reportImg) { reportImg.classList.remove('is-visible'); reportImg.classList.add('d-none'); }
    if (btns) { btns.classList.remove('d-flex'); btns.classList.add('d-none'); }

    try {
      const fd = new FormData(form);
      if (submitter && submitter.name) fd.set(submitter.name, submitter.value);
      fd.set('ajax', '1');

      const res  = await fetch(form.getAttribute('action'), {
        method: 'POST',
        body: fd,
        credentials: 'same-origin',
        headers: { 'X-Requested-With': 'fetch', 'Accept': 'application/json' }
      });
      const data = await res.json();
      if (!res.ok || !data.ok) throw new Error(data.error || `HTTP ${res.status}`);

      if (data.plot_png_b64) {
        reportImg.src = 'data:image/png;base64,' + data.plot_png_b64;
        reportImg.classList.remove('d-none');
        requestAnimationFrame(() => reportImg.classList.add('is-visible'));
        if (msg) msg.style.display = 'none';
      } else {
        if (msg) msg.textContent = data.error || 'No chart to display.';
      }

      // Toggle export buttons
      if (btns) {
        if (data.display) { btns.classList.remove('d-none'); btns.classList.add('d-flex'); }
        else { btns.classList.remove('d-flex'); btns.classList.add('d-none'); }
      }

      // Header HTML refresh
      if (data.header_html) {
        const headerLeft = document.getElementById('report-header-left');
        if (headerLeft) headerLeft.innerHTML = data.header_html;
      }
    } catch (err) {
      console.error(err);
      if (msg) msg.textContent = 'Sorry — there was a problem loading the report.';
      if (btns) { btns.classList.remove('d-flex'); btns.classList.add('d-none'); }
    }
  });
})();
</script>

{% endblock %}
