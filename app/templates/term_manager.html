{# templates/term_manager.html #}
{% extends "header.html" %}
{% block title %}Term Manager{% endblock %}

{% block content %}
<div class="container my-4">
  <h2 class="mb-3">Term Manager</h2>

  <form method="post" class="row gy-2 gx-3 align-items-end mb-3">
    <!-- Year -->
    <div class="col-auto">
      <label for="year" class="form-label mb-0">Calendar Year</label>
      <select id="year" name="year" class="form-select">
        <option value="">-- select --</option>
        {% for y in years %}
          <option value="{{ y }}" {{ 'selected' if selected_year == y else '' }}>{{ y }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Term -->
    <div class="col-auto">
      <label for="term" class="form-label mb-0">Term</label>
      <select id="term" name="term" class="form-select">
        <option value="">-- select --</option>
        {% for t in [1,2,3,4] %}
          <option value="{{ t }}" {{ 'selected' if selected_term == t else '' }}>{{ t }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- School (enabled only when Year & Term picked) -->
    {% set school_disabled = (not selected_year or not selected_term) %}
    <div class="col-auto">
      <label for="moe" class="form-label mb-0">School</label>
      <select id="moe" name="moe" class="form-select" {{ '' if not school_disabled else 'disabled' }}>
        <option value="">-- select --</option>
        {% for s in schools %}
          <option value="{{ s.MOENumber }}" {{ 'selected' if selected_moe == s.MOENumber else '' }}>
            {{ s.SchoolName }} ({{ s.MOENumber }})
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="col-auto">
      <button type="submit" class="btn btn-primary">Load</button>
    </div>
  </form>

  {% if classes %}
  <div class="card shadow-sm">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">
          Classes ({{ classes|length }}) â€” {{ selected_year }}, Term {{ selected_term }}
        </h5>
        <button id="saveBtn" class="btn btn-success btn-sm">Save changes</button>
      </div>

      <div class="table-responsive mt-3">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>ClassID</th>
              <th>Class Name</th>
              <th>Teacher</th>
              <th>School</th>
              <th>Year</th>
              <th>Current Term</th>
              <th>New Term</th>
            </tr>
          </thead>
          <tbody>
            {% for c in classes %}
            <tr>
              <td>{{ c.ClassID }}</td>
              <td>{{ c.ClassName }}</td>
              <td>{{ c.TeacherName }}</td>
              <td>{{ c.SchoolName }} ({{ c.MOENumber }})</td>
              <td>{{ c.CalendarYear }}</td>
              <td><span class="badge bg-secondary">{{ c.Term }}</span></td>
              <td style="max-width:8rem">
                <select class="form-select form-select-sm term-select"
                        data-class-id="{{ c.ClassID }}"
                        data-old-term="{{ c.Term }}">
                  {% for t in [1,2,3,4] %}
                    <option value="{{ t }}" {{ 'selected' if t == c.Term else '' }}>{{ t }}</option>
                  {% endfor %}
                </select>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <small class="text-muted">Only rows where the term changed will be saved.</small>
    </div>
  </div>
  {% elif selected_year and selected_term and selected_moe %}
    <div class="alert alert-info mt-3">No classes found for this selection.</div>
  {% endif %}
</div>

<script>
(function(){
  // Enable School only after Year & Term picked
  const year = document.getElementById('year');
  const term = document.getElementById('term');
  const moe  = document.getElementById('moe');
  function toggleSchool() {
    moe.disabled = !(year.value && term.value);
  }
  year?.addEventListener('change', toggleSchool);
  term?.addEventListener('change', toggleSchool);
  toggleSchool();

  // Save
  const saveBtn = document.getElementById("saveBtn");
  if (!saveBtn) return;

  saveBtn.addEventListener("click", async () => {
    const selects = document.querySelectorAll(".term-select[data-class-id][data-old-term]");
    const changes = [];
    selects.forEach(sel => {
      const cid  = Number(sel.dataset.classId);
      const oldt = Number(sel.dataset.oldTerm);
      const newt = Number(sel.value);
      if (cid && [1,2,3,4].includes(newt) && newt !== oldt) {
        changes.push({ class_id: cid, new_term: newt });
      }
    });
    if (!changes.length) { alert("No term changes to save."); return; }

    try {
      const res = await fetch("/api/term-manager/save", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ changes })
      });
      const data = await res.json();
      if (data.ok) { alert("Saved!"); location.reload(); }
      else { console.error(data); alert("Some updates failed. Check console."); }
    } catch (e) {
      console.error(e); alert("Request failed.");
    }
  });
})();
</script>
{% endblock %}
