{% extends "header.html" %}
{% block title %}Overview{% endblock %}

{% block content %}
<div class="container mt-5" style="max-width: 95%;">



  <h2 class="text-center text-primary mb-4">{{ title }}</h2>

  {% if user_role == "ADM" or (user_role in ["FUN","PRO","GRP"] and user_admin == 1) %}
  <form method="POST" class="mb-4" id="entityForm">
    <div class="row g-2 align-items-end justify-content-center">
      <div class="col-md-3">
        <label for="entity_type" class="form-label">Entity Type</label>
        <select name="entity_type" id="entity_type" class="form-select">
          {% if user_role in ["ADM","FUN"] %}
            <option value="Funder"   {% if entity_type == "Funder" %}selected{% endif %}>Funder</option>
          {% endif %}
          {% if (user_role in ["ADM","FUN","GRP"] and has_groups) or user_role=="GRP" %}
            <option value="Group"    {% if entity_type == "Group" %}selected{% endif %}>Provider Group</option>
          {% endif %}
          <option value="Provider"   {% if entity_type == "Provider" %}selected{% endif %}>Provider</option>
        </select>
      </div>

      <div class="col-md-5">
        <label for="entity_id" class="form-label" id="entityLabel">Select</label>
        <select name="entity_id" id="entity_id" class="form-select" disabled>
          <option value="">-- Choose an Entity Type first --</option>
        </select>
      </div>

      <div class="col-md-2">
        <button type="submit" class="btn btn-primary w-100">Submit</button>
      </div>
    </div>
  </form>
  {% endif %}

  {% if summary_string %}
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="alert text-center align-items-center gap-2" style="background-color:#4d544120;color:#4d5441;border:2px solid #4d5441;">
        <span>{{ summary_string | safe }}</span>
      </div>
    </div>
  </div>
  {% endif %}

  {% if selected_entity_id %}
  <div class="row g-4">
    <!-- Column 1: Staff eLearning -->
    <div class="col-md-8">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">Your Staff eLearning Progress</h5>
        </div>
        <div class="card-body">
          {% if eLearning and not no_eLearning %}

          <!-- ðŸ”Ž Filters & Sorting -->
          <div class="row g-2 mb-3">
            <div class="col-md-4">
              <label for="filterName" class="form-label">Search staff</label>
              <input id="filterName" class="form-control" type="text" placeholder="Type a nameâ€¦">
            </div>
            <div class="col-md-3">
              <label for="filterReview" class="form-label">Self review</label>
              <select id="filterReview" class="form-select">
                <option value="any" selected>Any</option>
                <option value="has">Has self review</option>
                <option value="none">No self review</option>
              </select>
            </div>
            <div class="col-md-3">
              <label for="filterStatus" class="form-label">Course status</label>
              <select id="filterStatus" class="form-select">
                <option value="any" selected>Any</option>
                <option>Passed</option>
                <option>Completed</option>
                <option>In Progress</option>
                <option>Cancelled</option>
                <option>Not Started</option>
                <option>Enrolled</option>
                <option>Not Enrolled</option>
              </select>
            </div>
            <div class="col-md-2">
              <label for="sortBy" class="form-label">Sort</label>
              <select id="sortBy" class="form-select">
                <option value="none" selected>None</option>
                <option value="mostCompleted">Most completed</option>
                <option value="leastCompleted">Least completed</option>
                <option value="nameAZ">Name A â†’ Z</option>
                <option value="nameZA">Name Z â†’ A</option>
              </select>
            </div>
          </div>

          <div class="table-responsive">
            <table class="table table-bordered text-center align-middle">
              <thead class="table-light">
                <tr>
                  <th>Staff</th>
                  {% for module in eLearning[0].keys() if module not in ['Name','RespondentID'] %}
                    <th>{{ module }}</th>
                  {% endfor %}
                </tr>
              </thead>
              <tbody>
                {% for row in eLearning %}
                <tr>
                  <td>{{ row["Name"] }}</td>
                  {% for key, val in row.items() if key not in ["Name","RespondentID"] %}
                  <td>
                    {% set status = val|string %}
                    {% if key == "Latest Self Review" and val %}
                      <a href="{{ url_for('survey_bp.view_my_survey_response', respondent_id=row['RespondentID']) }}" style="text-decoration:none;">
                        <span class="badge bg-light text-dark" style="font-size:0.8rem;">
                          {{ status }}
                        </span>
                      </a>
                    {% else %}
                      {% if status in ['Passed','Completed'] %}
                        <span class="badge bg-success" style="font-size:0.8rem;">{{ status }}</span>
                      {% elif status == 'Cancelled' %}
                        <span class="badge bg-danger" style="font-size:0.8rem;">{{ status }}</span>
                      {% elif status == 'In Progress' %}
                        <span class="badge bg-warning text-dark" style="font-size:0.8rem;">{{ status }}</span>
                      {% elif status in ['Not Started','Enrolled','Not Enrolled'] %}
                        <span class="badge bg-secondary" style="font-size:0.8rem;">{{ status }}</span>
                      {% else %}
                        <span class="badge bg-light text-dark" style="font-size:0.8rem;">{{ status }}</span>
                      {% endif %}
                    {% endif %}
                  </td>
                  {% endfor %}
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div class="alert alert-warning mb-0">No eLearning data available.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Column 2: School Summary -->
    <div class="col-md-4">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">School Summary</h5>
        </div>
        <div class="card-body">
          <form method="POST" class="row g-2 mb-3" id="filterForm">
            <input type="hidden" name="entity_id" value="{{ selected_entity_id }}">
            <input type="hidden" name="entity_type" value="{{ entity_type }}">
            <div class="col-md-6">
              <label for="term" class="form-label">Term</label>
              <select name="term" id="term" class="form-select" onchange="document.getElementById('filterForm').submit();">
                {% for t in available_terms %}
                  <option value="{{ t }}" {% if selected_term|int == t %}selected{% endif %}>Term {{ t }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-6">
              <label for="year" class="form-label">Year</label>
              <select name="year" id="year" class="form-select" onchange="document.getElementById('filterForm').submit();">
                {% for y in available_years %}
                  <option value="{{ y }}" {% if selected_year|int == y %}selected{% endif %}>{{ y }}</option>
                {% endfor %}
              </select>
            </div>
          </form>

          {% if schools and not no_schools %}
          <div class="table-responsive">
            <table class="table table-bordered text-center align-middle">
              <thead class="table-light">
                <tr>
                  {% for col in schools[0].keys() %}
                    <th>
                      {{ col.replace('_',' ') }}
                      {% if col == 'Classes Edited' %}
                        <i class="bi bi-info-circle-fill text-primary ms-1" data-bs-toggle="tooltip" data-bs-placement="top"
                           title="This is calculated by counting classes where at least 85% of students were edited."></i>
                      {% endif %}
                    </th>
                  {% endfor %}
                </tr>
              </thead>
              <tbody>
                {% for row in schools %}
                  <tr>
                    {% for val in row.values() %}
                      <td>{{ val }}</td>
                    {% endfor %}
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div class="alert alert-warning mb-0">No school summary data for the selected term and year.</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  {% elif user_role == "ADM" %}
  <div class="d-flex justify-content-center">
    <div class="alert alert-info mt-4 w-75 text-center">
      Please select an entity from the dropdown above to view the dashboard.
    </div>
  </div>
  {% endif %}
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const entityTypeSel = document.getElementById("entity_type");
  const entityIdSel   = document.getElementById("entity_id");
  const label         = document.getElementById("entityLabel");
  const spinner       = document.getElementById("loadingSpinner");
  const submitBtn     = document.querySelector('#entityForm button[type="submit"]');

  function showSpinner(on) { if (spinner) spinner.style.display = on ? "block" : "none"; }
  function setDisabled(on) {
    if (entityIdSel) entityIdSel.disabled = on;
    if (submitBtn)   submitBtn.disabled   = on;
  }
  function makeOpt(text, value, selected=false) {
    const o = document.createElement("option");
    o.textContent = text; o.value = value ?? ""; if (selected) o.selected = true; return o;
  }

  async function loadEntities(type) {
    if (!entityIdSel || !type) return;
    label.textContent = `Select ${type}`;
    entityIdSel.replaceChildren(makeOpt(`Loading ${type}s...`, ""));
    setDisabled(true); showSpinner(true);

    try {
      // Adjust to your endpoint; expects JSON like: [{ id, name }]
      const url = "{{ url_for('funder_bp.get_entities') }}?entity_type=" + encodeURIComponent(type);
      const res = await fetch(url, { headers: { "Accept": "application/json" } });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      const list = Array.isArray(data) ? data : (data.entities || []);

      entityIdSel.replaceChildren(makeOpt(`-- Choose a ${type} --`, ""));
      for (const item of list) {
        const id   = item.id   ?? item.ProviderID ?? item.FunderID ?? item.GroupID;
        const name = item.name ?? item.ProviderName ?? item.Description ?? item.GroupName;
        if (!id || !name) continue;
        entityIdSel.appendChild(makeOpt(name, id));
      }

      setDisabled(false);
    } catch (err) {
      console.error("Error loading entities:", err);
      entityIdSel.replaceChildren(makeOpt(`Error loading ${type}s`, ""));
      setDisabled(false);
    } finally {
      showSpinner(false);
    }
  }

  // Initial state: disabled until a type is picked
  if (entityIdSel) {
    entityIdSel.disabled = true;
    entityIdSel.innerHTML = '<option value="">-- Choose an Entity Type first --</option>';
  }

  // When the user picks a type, load via AJAX
  entityTypeSel?.addEventListener("change", function () {
    if (!this.value) {
      entityIdSel.disabled = true;
      entityIdSel.innerHTML = '<option value="">-- Choose an Entity Type first --</option>';
      return;
    }
    loadEntities(this.value);
  });

  // Optional: if the page arrives with a preselected type, load it
  if (entityTypeSel?.value) loadEntities(entityTypeSel.value);

  // Bootstrap tooltips
  const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  tooltipTriggerList.forEach(el => new bootstrap.Tooltip(el));
});
</script>

<!-- ðŸ”Ž Client-side filters/sorting for eLearning table -->
<script>
(function () {
  function debounce(fn, ms) {
    let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); };
  }
  function headerIndexByText(table, text) {
    const ths = table.querySelectorAll('thead th');
    for (let i = 0; i < ths.length; i++) {
      if (ths[i].textContent.trim().toLowerCase() === text.trim().toLowerCase()) return i;
    }
    return -1;
  }

  document.addEventListener('DOMContentLoaded', function () {
    const table = document.querySelector('.card-body table.table');
    if (!table) return;

    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));

    const nameColIdx = 0; // "Staff" column
    const selfReviewColIdx = headerIndexByText(table, 'Latest Self Review');

    const filterName    = document.getElementById('filterName');
    const filterReview  = document.getElementById('filterReview');
    const filterStatus  = document.getElementById('filterStatus');
    const sortBy        = document.getElementById('sortBy');

    function rowMeta(tr) {
      const tds = tr.querySelectorAll('td');
      const name = (tds[nameColIdx]?.textContent || '').trim().toLowerCase();

      let hasSelfReview = false;
      if (selfReviewColIdx >= 0) {
        const cell = tds[selfReviewColIdx];
        hasSelfReview = !!(cell && cell.querySelector('a'));
      }

      let completedCount = 0;
      const good = new Set(['passed','completed']);
      tds.forEach((td, idx) => {
        if (idx === nameColIdx || idx === selfReviewColIdx) return;
        const txt = (td.textContent || '').trim().toLowerCase();
        if (good.has(txt)) completedCount += 1;
      });

      return { name, hasSelfReview, completedCount, tds };
    }

    const cache = new Map();
    rows.forEach(tr => cache.set(tr, rowMeta(tr)));

    function rowMatchesFilters(meta) {
      const q = (filterName?.value || '').trim().toLowerCase();
      if (q && !meta.name.includes(q)) return false;

      const rv = filterReview?.value || 'any';
      if (rv === 'has' && !meta.hasSelfReview) return false;
      if (rv === 'none' && meta.hasSelfReview) return false;

      const sel = (filterStatus?.value || 'any');
      if (sel && sel !== 'any') {
        let anyMatch = false;
        meta.tds.forEach((td, idx) => {
          if (idx === nameColIdx) return;
          const text = (td.textContent || '').trim().toLowerCase();
          if (text === sel.toLowerCase()) anyMatch = true;
        });
        if (!anyMatch) return false;
      }
      return true;
    }

    function applyFilters() {
      rows.forEach(tr => {
        const meta = cache.get(tr);
        tr.style.display = rowMatchesFilters(meta) ? '' : 'none';
      });
    }

    function applySort() {
      const visibleRows = rows.filter(tr => tr.style.display !== 'none');
      const mode = (sortBy?.value || 'none');

      if (mode === 'none') return;

      const decorated = visibleRows.map((tr) => {
        const meta = cache.get(tr);
        return { tr, name: meta.name, completed: meta.completedCount };
      });

      if (mode === 'mostCompleted') {
        decorated.sort((a, b) => b.completed - a.completed || a.name.localeCompare(b.name));
      } else if (mode === 'leastCompleted') {
        decorated.sort((a, b) => a.completed - b.completed || a.name.localeCompare(b.name));
      } else if (mode === 'nameAZ') {
        decorated.sort((a, b) => a.name.localeCompare(b.name));
      } else if (mode === 'nameZA') {
        decorated.sort((a, b) => b.name.localeCompare(a.name));
      }

      decorated.forEach(({ tr }) => tbody.appendChild(tr));
    }

    const run = () => { applyFilters(); applySort(); };
    const runDebounced = debounce(run, 150);

    filterName?.addEventListener('input', runDebounced);
    filterReview?.addEventListener('change', run);
    filterStatus?.addEventListener('change', run);
    sortBy?.addEventListener('change', run);

    run();
  });
})();
</script>

{% endblock %}
