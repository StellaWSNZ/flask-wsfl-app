{% extends "header.html" %}
<!-- -->

{% block title %}Create User{% endblock %}
<!-- -->

{% block content %}
<!-- -->
{% if user_role == 'MOE' %}
<div class="alert alert-info">
  You are creating a <strong>school user</strong> for
  <strong>{{ name }}</strong>.
</div>
{% elif user_role == 'FUN' %}
<div class="alert alert-info">
  {% if not only_own_staff_or_empty %} You are creating a user for {{ name }},
  one of its providers or one of its schools. Choose a role and target entity
  below. {% else %} You are creating a user for {{ name }} or one of its
  schools. Choose a role and target entity below. {% endif %}
</div>
{% endif %} {% with messages = get_flashed_messages(with_categories=true) %} {%
if messages %} {% for category, message in messages %}
<div
  class="alert alert-{{ category }} alert-dismissible fade show"
  role="alert"
>
  {{ message }}
  <button
    type="button"
    class="btn-close"
    data-bs-dismiss="alert"
    aria-label="Close"
  ></button>
</div>
{% endfor %} {% endif %} {% endwith %}
<div class="card">
  <div class="card-header bg-secondary text-white">Create New User</div>
  <div class="card-body">
    <form method="POST">
      <!-- Email -->
      <div class="mb-3">
        <label class="form-label">Email</label>
        <input type="email" name="email" class="form-control" required />
      </div>

      <!-- First Name -->
      <div class="mb-3">
        <label class="form-label">First Name</label>
        <input type="text" name="firstname" class="form-control" required />
      </div>

      <!-- Surname -->
      <div class="mb-3">
        <label class="form-label">Surname</label>
        <input type="text" name="surname" class="form-control" required />
      </div>

      {% if user_role == 'FUN' %}
      <!-- Role Selector -->
      <div class="mb-3">
        <label class="form-label">Select Role</label>
        <select
          name="selected_role"
          id="selected_role"
          class="form-select"
          required
        >
          <option disabled selected value="">Choose...</option>
          <option value="MOE">School</option>
          {% if not only_own_staff_or_empty %}
          <option value="PRO">Provider</option>

          {% endif %}
          <option value="FUN">Funder</option>
        </select>
      </div>

      <div class="mb-3" id="funder-section" style="display: none">
        <label class="form-label">Select Funder</label>
        <select id="funder-id" class="form-select">
          <option value="{{ funder.id }}">{{ funder.Description }}</option>
        </select>
      </div>

      <!-- Provider -->
      <div class="mb-3" id="provider-section" style="display: none">
        <label class="form-label">Select Provider</label>
        <select id="provider-id" class="form-select">
          {% for p in providers %}
          <option value="{{ p.id }}">{{ p.Description }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- School -->
      <div class="mb-3" id="school-section" style="display: none">
        <label class="form-label">Select School</label>
        <select id="school-id" class="form-select">
          {% for s in schools %}
          <option value="{{ s.id }}">{{ s.description }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Shared hidden input to store selected ID -->
      <input type="hidden" name="selected_id" id="selected_id" />

      <!-- Admin Checkbox -->
      <div class="form-check mb-3">
        <input
          class="form-check-input"
          type="checkbox"
          value="1"
          name="admin"
          id="adminCheck"
        />
        <label class="form-check-label" for="adminCheck">
          Administrator Permissions
        </label>
      </div>

      <!-- Email Checkbox -->
      <div class="form-check mb-3">
        <input
          class="form-check-input"
          type="checkbox"
          name="send_email"
          id="sendEmail"
        />
        <label class="form-check-label" for="sendEmail">
          Send confirmation email to user
        </label>
      </div>

      <button type="submit" class="btn btn-success">Create User</button>
    </form>
  </div>
</div>
{% endif %} {% endblock %} {% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const roleSelect = document.getElementById("selected_role");
    const funderSection = document.getElementById("funder-section");
    const providerSection = document.getElementById("provider-section");
    const schoolSection = document.getElementById("school-section");
    const selectedIdInput = document.getElementById("selected_id");

    const funderDropdown = document.getElementById("funder-id");
    const providerDropdown = document.getElementById("provider-id");
    const schoolDropdown = document.getElementById("school-id");

    function updateSelectedId() {
      if (roleSelect.value === "FUN" && funderDropdown) {
        selectedIdInput.value = funderDropdown.value;
      } else if (roleSelect.value === "PRO" && providerDropdown) {
        selectedIdInput.value = providerDropdown.value;
      } else if (roleSelect.value === "MOE" && schoolDropdown) {
        selectedIdInput.value = schoolDropdown.value;
      } else {
        selectedIdInput.value = "";
      }
    }

    roleSelect.addEventListener("change", function () {
      funderSection.style.display = "none";
      providerSection.style.display = "none";
      schoolSection.style.display = "none";

      if (this.value === "FUN") {
        funderSection.style.display = "block";
      } else if (this.value === "PRO") {
        providerSection.style.display = "block";
      } else if (this.value === "MOE") {
        schoolSection.style.display = "block";
      }
      updateSelectedId();
    });

    [funderDropdown, providerDropdown, schoolDropdown].forEach((dropdown) => {
      if (dropdown) {
        dropdown.addEventListener("change", updateSelectedId);
      }
    });
  });
</script>
{% endblock %}
